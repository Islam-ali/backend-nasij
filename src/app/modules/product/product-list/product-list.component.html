<p-toast></p-toast>
<p-toolbar styleClass="mb-4 gap-2">
    <ng-template pTemplate="left">
        <div class="my-2">
            <p-button severity="success" [label]="'product.new' | translate" icon="pi pi-plus" class="mr-2" (click)="openNew()"
                [style]="{'margin-right': '.5em'}">
            </p-button>
        </div>
    </ng-template>
    <ng-template pTemplate="right">
        <div class="flex items-center gap-2">
            <label class="font-semibold">{{ 'common.language' | translate }}:</label>
            <p-dropdown [options]="languages()" [ngModel]="currentLanguage()" 
                (onChange)="onLanguageChange($event)" optionLabel="label" optionValue="value" 
                styleClass="w-32">
            </p-dropdown>
        </div>
    </ng-template>
</p-toolbar>

<p-table #dt [value]="products()" [columns]="cols" responsiveLayout="scroll" [lazy]="true" [loading]="loading()"
    [globalFilterFields]="['name','category.name.en','status']" [showCurrentPageReport]="true"
    [(selection)]="selectedProducts" selectionMode="multiple" [rowHover]="true" dataKey="_id">
    <ng-template pTemplate="caption">
        <div class="flex flex-column md:flex-row md:justify-between md:align-items-center">
            <h5 class="m-0">{{ 'product.manage' | translate }}</h5>
            <p-iconField iconPosition="left" class="ms-auto">
                <p-inputIcon>
                    <i class="pi pi-search"></i>
                </p-inputIcon>
                <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" [placeholder]="'common.search' | translate"
                    class="w-full sm:w-auto" />
            </p-iconField>
        </div>
    </ng-template>

    <ng-template pTemplate="header">
        <tr>
            <th pSortableColumn="name">{{ 'common.name' | translate }} <p-sortIcon field="name"></p-sortIcon></th>
            <th>{{ 'product.image' | translate }}</th>
            <th pSortableColumn="price">{{ 'common.price' | translate }} <p-sortIcon field="price"></p-sortIcon></th>
            <th pSortableColumn="category">{{ 'product.category' | translate }} <p-sortIcon field="category"></p-sortIcon></th>
            <!-- <th>Reviews</th> -->
            <th pSortableColumn="status">{{ 'common.status' | translate }} <p-sortIcon field="status"></p-sortIcon></th>
            <th></th>
        </tr>
    </ng-template>

    <ng-template pTemplate="body" let-product>
        <tr>
            <td style="width:14%; min-width:10rem;">
                <span class="font-medium">{{ product.name | multiLanguage:currentLanguage() }}</span>
            </td>
            <td style="width:14%; min-width: 10rem;">
                <img [src]="getImageUrl(product.images?.[0].filePath)" [alt]="product.name" width="64" height="64"
                    class="shadow-4 border-round" [fallback]="'/images/picture.png'" />
            </td>
            <td style="width:14%; min-width:8rem;">
                <span class="font-semibold">${{ product.price }}</span>
            </td>
            <td style="width:14%; min-width:10rem;">
                        {{ product.category?.name | multiLanguage:currentLanguage() }}
            </td>
            <!-- <td style="width:14%; min-width: 10rem;">
                <p-rating [ngModel]="product.rating" [readonly]="true"></p-rating>
            </td> -->
            <td style="width:14%; min-width: 10rem;">
                <p-tag [value]="product.status" [severity]="getSeverity(product.status)"></p-tag>
            </td>
            <td>
                <div class="flex">
                    <p-button icon="pi pi-pencil" class="mr-2" [rounded]="true" [outlined]="true" severity="success"
                        (click)="editProduct(product)"></p-button>
                    <p-button icon="pi pi-trash" severity="warn" [rounded]="true" [outlined]="true"
                        (click)="deleteProduct(product)"></p-button>
                </div>
            </td>
        </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
        <tr>
            <td colspan="7" class="text-center py-6">
                <div class="flex flex-column gap-2 items-center justify-center">
                    <i class="pi pi-inbox text-5xl text-400"></i>
                    <span class="text-xl text-600">{{ 'product.noData' | translate }}</span>
                </div>
            </td>
        </tr>
    </ng-template>

    <!-- <ng-template pTemplate="loadingbody">
        <tr *ngFor="let x of [1,2,3,4,5]">
            <td *ngFor="let col of cols">
                <p-skeleton width="100%" height="30px" />
            </td>
        </tr>
    </ng-template> -->

    <ng-template pTemplate="footer">
        <tr>
            <td colspan="7" class="text-center py-6">
                <p-paginator appendTo="body" [dropdownAppendTo]="'body'" [rows]="pagination().limit"
                    [totalRecords]="pagination().total" (onPageChange)="loadProducts($event.page, $event.rows)"
                    [rowsPerPageOptions]="[5,10,20,30]" [pageLinkSize]="5" [showPageLinks]="true"
                    [showCurrentPageReport]="true"
                    currentPageReportTemplate="{{ 'product.paging' | translate }}">
                </p-paginator>
            </td>
        </tr>
    </ng-template>
</p-table>

<!-- Enhanced Product Dialog with Accordion -->
<p-dialog [(visible)]="productDialog" [style]="{width: '70vw'}" [header]="'product.dialogTitle' | translate" [modal]="true" class="p-fluid"
    [maximizable]="true" [closable]="true">

    <ng-template pTemplate="content">
        @if (productDialog) {
        <form [formGroup]="productForm" class="formgrid grid">

            <p-accordion [multiple]="true" [activeIndex]="[0, 1]" class="w-full">

                <!-- Basic Information Panel -->
                <p-accordionTab [header]="'product.basicInfo' | translate" [selected]="true">
                    <ng-template pTemplate="content">

                        <!-- Product Name -->
                        <div class="field w-full mb-4">
                            <label class="font-semibold">{{ 'product.productName' | translate }} *</label>
                            <ng-container formGroupName="name">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">{{ 'common.nameEn' | translate }} *</label>
                                        <input pInputText formControlName="en" class="w-full"
                                            [placeholder]="'product.nameEnPlaceholder' | translate"
                                            [class.ng-invalid]="submitted && productForm.get('name.en')?.invalid" />
                                        <small class="text-red-500"
                                            *ngIf="submitted && productForm.get('name.en')?.invalid">
                                            {{ 'product.nameEnRequired' | translate }}
                                        </small>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">{{ 'common.nameAr' | translate }} *</label>
                                        <input pInputText formControlName="ar" class="w-full"
                                            [placeholder]="'product.nameArPlaceholder' | translate"
                                            [class.ng-invalid]="submitted && productForm.get('name.ar')?.invalid" />
                                        <small class="text-red-500"
                                            *ngIf="submitted && productForm.get('name.ar')?.invalid">
                                            {{ 'product.nameArRequired' | translate }}
                                        </small>
                                    </div>
                                </div>
                            </ng-container>
                        </div>

                        <!-- Product Description -->
                        <div class="field w-full mb-4">
                            <label class="font-semibold">{{ 'common.description' | translate }} *</label>
                            <ng-container formGroupName="description">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">{{ 'common.descriptionEn' | translate }} *</label>
                                        <textarea pTextarea formControlName="en" rows="4" class="w-full"
                                            [placeholder]="'product.descriptionEnPlaceholder' | translate"
                                            [class.ng-invalid]="submitted && productForm.get('description.en')?.invalid">
                                        </textarea>
                                        <small class="text-red-500"
                                            *ngIf="submitted && productForm.get('description.en')?.invalid">
                                            {{ 'product.descriptionEnRequired' | translate }}
                                        </small>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">{{ 'common.descriptionAr' | translate }} *</label>
                                        <textarea pTextarea formControlName="ar" rows="4" class="w-full"
                                            [placeholder]="'product.descriptionArPlaceholder' | translate"
                                            [class.ng-invalid]="submitted && productForm.get('description.ar')?.invalid">
                                        </textarea>
                                        <small class="text-red-500"
                                            *ngIf="submitted && productForm.get('description.ar')?.invalid">
                                            {{ 'product.descriptionArRequired' | translate }}
                                        </small>
                                    </div>
                                </div>
                            </ng-container>
                        </div>
                    </ng-template>
                </p-accordionTab>

                <!-- Pricing & Inventory Panel -->
                <p-accordionTab [header]="'product.pricingInventory' | translate" [selected]="true">
                    <ng-template pTemplate="content">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div class="field w-full ">
                                <label for="factoryPrice" class="font-semibold">{{ 'product.factoryPrice' | translate }} *</label>
                                <p-inputNumber id="factoryPrice" class="w-full" formControlName="factoryPrice"
                                    mode="currency" currency="USD" locale="en-US"
                                    [class.ng-invalid]="submitted && productForm.get('factoryPrice')?.invalid">
                                </p-inputNumber>
                                <small class="ng-dirty ng-invalid text-red-500"
                                    *ngIf="submitted && productForm.get('factoryPrice')?.invalid">
                                    {{ 'product.factoryPriceRequired' | translate }}
                                </small>
                            </div>

                            <div class="field w-full ">
                                <label for="price" class="font-semibold">{{ 'common.price' | translate }} *</label>
                                <p-inputNumber id="price" class="w-full" formControlName="price" mode="currency"
                                    currency="USD" locale="en-US"
                                    [class.ng-invalid]="submitted && productForm.get('price')?.invalid">
                                </p-inputNumber>
                                <small class="ng-dirty ng-invalid text-red-500"
                                    *ngIf="submitted && productForm.get('price')?.invalid">
                                    {{ 'product.priceRequired' | translate }}
                                </small>
                            </div>
                            <div class="field w-full">
                                <label for="useVariantPrice" class="font-semibold">{{ 'product.useVariantPrice' | translate }}</label>
                                <p-toggleswitch id="useVariantPrice" formControlName="useVariantPrice" />
                            </div>

                            <div class="field w-full ">
                                <label for="discountPrice" class="font-semibold">{{ 'product.discountPrice' | translate }}</label>
                                <p-inputNumber id="discountPrice" class="w-full" formControlName="discountPrice"
                                    mode="currency" currency="USD" locale="en-US">
                                </p-inputNumber>
                            </div>

                            <div class="field w-full ">
                                <label for="stock" class="font-semibold">{{ 'product.stock' | translate }} *</label>
                                <p-inputNumber id="stock" styleClass="w-full" formControlName="stock"
                                    [class.ng-invalid]="submitted && productForm.get('stock')?.invalid">
                                </p-inputNumber>
                                <small class="ng-dirty ng-invalid text-red-500"
                                    *ngIf="submitted && productForm.get('stock')?.invalid">
                                    {{ 'product.stockRequired' | translate }}
                                </small>
                            </div>

                            <div class="field w-full md:col-6">
                                <label for="status" class="font-semibold">{{ 'common.status' | translate }}</label>
                                <p-dropdown appendTo="body" id="status" styleClass="w-full" formControlName="status"
                                    [options]="statusOptions" [placeholder]="'product.selectStatus' | translate">
                                </p-dropdown>
                            </div>
                        </div>
                    </ng-template>
                </p-accordionTab>

                <!-- Category & Brand Panel -->
                <p-accordionTab [header]="'product.categoryBrand' | translate">
                    <ng-template pTemplate="content">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div class="field w-full md:col-6">
                                <label for="category" class="font-semibold">{{ 'product.category' | translate }} </label>
                                <p-dropdown appendTo="body" id="category" styleClass="w-full" formControlName="category"
                                    [options]="categoryOptions" [placeholder]="'product.selectCategory' | translate"
                                    optionLabel="label" optionValue="value"
                                    [class.ng-invalid]="submitted && productForm.get('category')?.invalid">
                                </p-dropdown>
                                <small class="ng-dirty ng-invalid text-red-500"
                                    *ngIf="submitted && productForm.get('category')?.invalid">
                                    {{ 'product.categoryRequired' | translate }}
                                </small>
                            </div>

                            <div class="field w-full md:col-6">
                                <label for="brand" class="font-semibold">{{ 'product.brand' | translate }} </label>
                                <p-dropdown appendTo="body" id="brand" styleClass="w-full" formControlName="brand"
                                    optionLabel="label" optionValue="value"
                                    [options]="brandOptions" [placeholder]="'product.selectBrand' | translate"
                                    [class.ng-invalid]="submitted && productForm.get('brand')?.invalid">
                                </p-dropdown>
                                <small class="ng-dirty ng-invalid text-red-500"
                                    *ngIf="submitted && productForm.get('brand')?.invalid">
                                    {{ 'product.brandRequired' | translate }}
                                </small>
                            </div>
                        </div>
                    </ng-template>
                </p-accordionTab>

                <!-- Product Images Panel -->
                <p-accordionTab [header]="'product.productImages' | translate">
                    <ng-template pTemplate="content">
                        <div class="field w-full">
                            <label class="font-semibold">{{ 'product.productImages' | translate }} *</label>
                            <app-upload-files [control]="formControlImage"
                                [filesServer]="productForm.get('images')?.value" [multiple]="true" [accept]="'image/*'">
                            </app-upload-files>
                            <small class="ng-dirty ng-invalid text-red-500"
                                *ngIf="submitted && productForm.get('images')?.invalid">
                                {{ 'product.imagesRequired' | translate }}
                            </small>
                        </div>
                    </ng-template>
                </p-accordionTab>

                <!-- Product Attributes Panel -->
                <p-accordionTab [header]="'product.productAttributes' | translate">
                    <ng-template pTemplate="content">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div class="field w-full md:col-6">
                                <label for="tags" class="font-semibold">{{ 'product.tags' | translate }}</label>
                                <p-chips id="tags" styleClass="w-full" formControlName="tags" [placeholder]="'product.addTags' | translate">
                                </p-chips>
                            </div>

                            <div class="field w-full ">
                                <label for="gender" class="font-semibold">{{ 'product.gender' | translate }}</label>
                                <p-dropdown appendTo="body" id="gender" styleClass="w-full" formControlName="gender"
                                    [options]="genderOptions" [placeholder]="'product.selectGender' | translate">
                                </p-dropdown>
                            </div>

                            <div class="field w-full ">
                                <label for="season" class="font-semibold">{{ 'product.season' | translate }}</label>
                                <p-dropdown appendTo="body" id="season" styleClass="w-full" formControlName="season"
                                    [options]="seasonOptions" [placeholder]="'product.selectSeason' | translate">
                                </p-dropdown>
                            </div>
                        </div>
                    </ng-template>
                </p-accordionTab>

                <!-- Product Variants Panel -->
                <p-accordionTab [header]="'product.productVariants' | translate">
                    <ng-template pTemplate="content">
                        <div class="flex justify-between align-items-center mb-3">
                            <h6 class="m-0">{{ 'product.variants' | translate }}</h6>
                            <p-button *ngIf="variants.length == 0" [label]="'product.addVariant' | translate" icon="pi pi-plus" size="small"
                                (click)="addVariant()">
                            </p-button>
                        </div>

                        <div formArrayName="variants">
                            <p-card *ngFor="let variant of variants.controls; let i = index" [formGroupName]="i"
                                styleClass="mb-3">
                                <ng-template pTemplate="header">
                                    <div class="flex justify-between align-items-center w-full px-3 py-2">
                                        <span class="font-semibold">{{ 'product.variant' | translate }} {{ i + 1 }}</span>
                                        <p-button icon="pi pi-trash" severity="danger" size="small" [text]="true"
                                            (click)="removeVariant(i)">
                                        </p-button>
                                    </div>
                                </ng-template>

                                <div class="grid grid-cols-1 gap-6">
                                    <!-- Attributes Section -->
                                    <div class="field w-full">
                                        <div class="flex items-center justify-between mb-4">
                                            <label class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                                                <i class="pi pi-tag text-primary"></i>
                                                {{ 'product.variantAttributes' | translate }} *
                                            </label>
                                        </div>
                                        
                                        <div formArrayName="attributes" class="space-y-4 w-full">
                                            <div *ngFor="let attribute of getAttributes(i).controls; let j = index"
                                                [formGroupName]="j" 
                                                class="bg-gray-50 rounded-lg p-4 border border-gray-200 hover:border-gray-300 transition-all duration-200">
                                                
                                                <div class="flex items-center justify-between mb-3">
                                                    <span class="text-sm font-medium text-gray-700">{{ 'product.attribute' | translate }} {{ j + 1 }}</span>
                                                    <p-button 
                                                        icon="pi pi-trash" 
                                                        severity="danger" 
                                                        size="small"
                                                        [text]="true" 
                                                        (click)="removeAttribute(i, j)"
                                                        *ngIf="getAttributes(i).length > 1"
                                                        class="hover:bg-red-100">
                                                    </p-button>
                                                </div>
                                                
                                                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                                                    <!-- Variant Type -->
                                                    <div class="field">
                                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                                            <i class="pi pi-list text-primary me-1"></i>
                                                            {{ 'product.type' | translate }}
                                                        </label>
                                                        <div class="flex gap-2">
                                                            <p-dropdown 
                                                                formControlName="variant" 
                                                                [options]="variantOptions"
                                                                [placeholder]="'product.selectVariantType' | translate" 
                                                                class="flex-1"
                                                                [class.ng-invalid]="submitted && attribute.get('variant')?.invalid">
                                                                <ng-template pTemplate="selectedItem" let-option>
                                                                    <div class="flex items-center gap-2">
                                                                        <i class="pi" [class]="getVariantIcon(option.value)"></i>
                                                                        <span>{{ option.label }}</span>
                                                                    </div>
                                                                </ng-template>
                                                                <ng-template pTemplate="item" let-option>
                                                                    <div class="flex items-center gap-2">
                                                                        <i class="pi" [class]="getVariantIcon(option.value)"></i>
                                                                        <span>{{ option.label }}</span>
                                                                    </div>
                                                                </ng-template>
                                                            </p-dropdown>
                                                            <button 
                                                                type="button" 
                                                                pButton 
                                                                icon="pi pi-plus" 
                                                                size="small" 
                                                                class="p-button-outlined"
                                                                (click)="toggleCustomVariantInput()"
                                                                [title]="'product.addCustomVariantType' | translate">
                                                            </button>
                                                        </div>
                                                        
                                                        <!-- Custom Variant Input -->
                                                        <div *ngIf="showCustomVariantInput" class="mt-2 p-3 bg-gray-50 rounded-lg border">
                                                            <div class="flex gap-2">
                                                                <input 
                                                                    pInputText 
                                                                    [(ngModel)]="customVariantInput"
                                                                    [placeholder]="'product.enterCustomVariantType' | translate"
                                                                    class="flex-1"
                                                                    (keyup.enter)="addCustomVariant()"
                                                                />
                                                                <button 
                                                                    type="button" 
                                                                    pButton 
                                                                    icon="pi pi-check" 
                                                                    size="small" 
                                                                    class="p-button-success"
                                                                    (click)="addCustomVariant()"
                                                                    [disabled]="!customVariantInput.trim()">
                                                                </button>
                                                                <button 
                                                                    type="button" 
                                                                    pButton 
                                                                    icon="pi pi-times" 
                                                                    size="small" 
                                                                    class="p-button-secondary"
                                                                    (click)="toggleCustomVariantInput()">
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <small class="text-red-500 text-xs" 
                                                            *ngIf="submitted && attribute.get('variant')?.invalid">
                                                            {{ 'product.variantTypeRequired' | translate }}
                                                        </small>
                                                    </div>
                                                    
                                                    <!-- Value -->
                                                    <div class="field">
                                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                                            <i class="pi pi-pencil text-primary me-1"></i>
                                                            {{ 'product.value' | translate }}
                                                        </label>
                                                        <ng-container formGroupName="value">
                                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                                <div>
                                                                    <label class="block text-sm font-medium text-gray-700 mb-2">{{ 'product.valueEn' | translate }} *</label>
                                                                    <input pInputText formControlName="en" class="w-full"
                                                                        [placeholder]="'product.enterValueEn' | translate"
                                                                        [class.ng-invalid]="submitted && attribute.get('value.en')?.invalid" />
                                                                    <small class="text-red-500"
                                                                        *ngIf="submitted && attribute.get('value.en')?.invalid">
                                                                        {{ 'product.valueEnRequired' | translate }}
                                                                    </small>
                                                                </div>
                                                                <div>
                                                                    <label class="block text-sm font-medium text-gray-700 mb-2">{{ 'product.valueAr' | translate }} *</label>
                                                                    <input pInputText formControlName="ar" class="w-full"
                                                                        [placeholder]="'product.enterValueAr' | translate"
                                                                        [class.ng-invalid]="submitted && attribute.get('value.ar')?.invalid" />
                                                                    <small class="text-red-500"
                                                                        *ngIf="submitted && attribute.get('value.ar')?.invalid">
                                                                        {{ 'product.valueArRequired' | translate }}
                                                                    </small>
                                                                </div>
                                                            </div>
                                                        </ng-container>
                                                    </div>
                                                    
                                                    <!-- Image Selection -->
                                                    <div class="field">
                                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                                            <i class="pi pi-image text-primary me-1"></i>
                                                            {{ 'product.imageOptional' | translate }}
                                                        </label>
                                                        <p-dropdown 
                                                            formControlName="image" 
                                                            class="w-full"
                                                            [options]="availableImages" 
                                                            optionLabel="fileName"
                                                            [placeholder]="'product.selectImage' | translate" 
                                                            [showClear]="true">
                                                            <ng-template pTemplate="selectedItem" let-image>
                                                                <div class="flex items-center gap-2">
                                                                    <img *ngIf="image.filePath" 
                                                                        [src]="getImageUrl(image.filePath)"
                                                                        [alt]="image.originalFileName"
                                                                        class="w-6 h-6 object-cover rounded border">
                                                                    <span class="truncate">{{ image.originalFileName }}</span>
                                                                </div>
                                                            </ng-template>
                                                            <ng-template pTemplate="item" let-image>
                                                                <div class="flex items-center gap-2">
                                                                    <img *ngIf="image.filePath" 
                                                                        [src]="getImageUrl(image.filePath)"
                                                                        [alt]="image.originalFileName"
                                                                        class="w-6 h-6 object-cover rounded border">
                                                                    <span class="truncate">{{ image.originalFileName }}</span>
                                                                </div>
                                                            </ng-template>
                                                        </p-dropdown>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Empty State -->
                                            <div *ngIf="getAttributes(i).length === 0" 
                                                class="text-center py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                                                <i class="pi pi-tag text-4xl text-gray-400 mb-3"></i>
                                                <p class="text-gray-500 mb-2">{{ 'product.noAttributesAdded' | translate }}</p>
                                                <p class="text-sm text-gray-400">{{ 'product.clickAddAttribute' | translate }}</p>
                                            </div>
                                        </div>
                                        <div class="col-span-2 mt-2">
                                            <p-button 
                                                [label]="'product.addAttribute' | translate" 
                                                icon="pi pi-plus" 
                                                size="small"
                                                (click)="addAttribute(i)" 
                                                [outlined]="true"
                                                class="">
                                        </p-button>
                                    </div>
                                        
                                        <small class="text-red-500 text-sm mt-2 block"
                                            *ngIf="submitted && variant.get('attributes')?.invalid">
                                            <i class="pi pi-exclamation-triangle me-1"></i>
                                            {{ 'product.atLeastOneAttributeRequired' | translate }}
                                        </small>
                                    </div>

                                    <!-- Variant Details Section -->
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                                        <!-- Price -->
                                        <div class="field" *ngIf="productForm.get('useVariantPrice')?.value">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                <i class="pi pi-dollar text-primary me-1"></i>
                                                {{ 'common.price' | translate }} *
                                            </label>
                                            <p-inputNumber 
                                                formControlName="price" 
                                                mode="currency" 
                                                currency="USD"
                                                locale="en-US" 
                                                class="w-full"
                                                [class.ng-invalid]="variant.get('price')?.dirty && variant.get('price')?.invalid">
                                            </p-inputNumber>
                                            <small class="text-red-500 text-xs" 
                                                *ngIf="variant.get('price')?.dirty && variant.get('price')?.invalid">
                                                <i class="pi pi-exclamation-triangle me-1"></i>
                                                {{ 'product.priceRequiredNonNegative' | translate }}
                                            </small>
                                        </div>

                                        <!-- Stock -->
                                        <div class="field">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                <i class="pi pi-box text-primary me-1"></i>
                                                {{ 'product.stock' | translate }} *
                                            </label>
                                            <p-inputNumber 
                                                (onInput)="onStockInput($event)" 
                                                formControlName="stock"
                                                class="w-full"
                                                [class.ng-invalid]="variant.get('stock')?.dirty && variant.get('stock')?.invalid">
                                            </p-inputNumber>
                                            <small class="text-red-500 text-xs" 
                                                *ngIf="variant.get('stock')?.dirty && variant.get('stock')?.invalid">
                                                <i class="pi pi-exclamation-triangle me-1"></i>
                                                {{ 'product.stockRequiredNonNegative' | translate }}
                                            </small>
                                        </div>

                                        <!-- SKU -->
                                        <div class="field">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                <i class="pi pi-barcode text-primary me-1"></i>
                                                {{ 'product.sku' | translate }} <span class="text-xs text-gray-500">({{ 'product.autoGeneratedIfEmpty' | translate }})</span>
                                            </label>
                                            <input 
                                                pInputText 
                                                formControlName="sku" 
                                                [placeholder]="'product.variantSku' | translate" 
                                                class="w-full"
                                                [class.ng-invalid]="submitted && variant.get('sku')?.invalid" />
                                            <small class="text-red-500 text-xs" 
                                                *ngIf="submitted && variant.get('sku')?.invalid">
                                                <i class="pi pi-exclamation-triangle me-1"></i>
                                                {{ 'product.skuFormat' | translate }}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </p-card>
                            <div class="my-2" *ngIf="variants.length > 0">
                                <p-button [label]="'product.addVariant' | translate" icon="pi pi-plus" size="small" (click)="addVariant()">
                                </p-button>
                            </div>
                        </div>

                        <div *ngIf="variants.length === 0" class="text-center py-4 text-500">
                            <i class="pi pi-info-circle me-2"></i>
                            {{ 'product.noVariantsAdded' | translate }}
                        </div>
                    </ng-template>
                </p-accordionTab>

                <!-- Product Details Panel -->
                <p-accordionTab [header]="'product.productDetails' | translate">
                    <ng-template pTemplate="content">
                        <div class="flex justify-between align-items-center mb-3">
                            <h6 class="m-0">{{ 'product.details' | translate }}</h6>
                            <p-button [label]="'product.addDetail' | translate" icon="pi pi-plus" size="small" (click)="addDetail()">
                            </p-button>
                        </div>
                        <!-- <p-card> -->
                        <div formArrayName="details">
                            <p-card *ngFor="let detail of details.controls; let i = index" [formGroupName]="i"
                                styleClass="mb-3">
                                <ng-template pTemplate="header">
                                    <div class="flex justify-between align-items-center w-full px-3 py-2">
                                        <span class="font-semibold">{{ 'product.detail' | translate }} {{ i + 1 }}</span>
                                        <p-button icon="pi pi-trash" severity="danger" size="small" [text]="true"
                                            (click)="removeDetail(i)">
                                        </p-button>
                                    </div>
                                </ng-template>
                                <!-- Detail Name -->
                                <div class="field w-full mb-4">
                                    <label class="font-semibold">{{ 'product.detailName' | translate }} *</label>
                                    <ng-container formGroupName="name">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">{{ 'common.nameEn' | translate }} *</label>
                                                <input pInputText formControlName="en" class="w-full"
                                                    [placeholder]="'product.enterDetailNameEn' | translate"
                                                    [class.ng-invalid]="submitted && detail.get('name.en')?.invalid" />
                                                <small class="text-red-500"
                                                    *ngIf="submitted && detail.get('name.en')?.invalid">
                                                    {{ 'product.nameEnRequired' | translate }}
                                                </small>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">{{ 'common.nameAr' | translate }} *</label>
                                                <input pInputText formControlName="ar" class="w-full"
                                                    [placeholder]="'product.enterDetailNameAr' | translate"
                                                    [class.ng-invalid]="submitted && detail.get('name.ar')?.invalid" />
                                                <small class="text-red-500"
                                                    *ngIf="submitted && detail.get('name.ar')?.invalid">
                                                    {{ 'product.nameArRequired' | translate }}
                                                </small>
                                            </div>
                                        </div>
                                    </ng-container>
                                </div>

                                <!-- Detail Value -->
                                <div class="field w-full mb-4">
                                    <label class="font-semibold">{{ 'product.detailValue' | translate }} *</label>
                                    <ng-container formGroupName="value">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">{{ 'product.valueEn' | translate }} *</label>
                                                <p-editor formControlName="en" [style]="{ height: '200px' }" />
                                                <small class="text-red-500"
                                                    *ngIf="submitted && detail.get('value.en')?.invalid">
                                                    {{ 'product.valueEnRequired' | translate }}
                                                </small>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">{{ 'product.valueAr' | translate }} *</label>
                                                <p-editor formControlName="ar" [style]="{ height: '200px' }" />
                                                <small class="text-red-500"
                                                    *ngIf="submitted && detail.get('value.ar')?.invalid">
                                                    {{ 'product.valueArRequired' | translate }}
                                                </small>
                                            </div>
                                        </div>
                                    </ng-container>
                                </div>
                                <!--   
                        <div class="field w-full md:col-2 mb-0">
                          <p-button 
                            icon="pi pi-trash" 
                            severity="danger" 
                            size="small" 
                            [outlined]="true" 
                            (click)="removeDetail(i)">
                          </p-button>
                        </div> -->
                            </p-card>
                        </div>

                        <div *ngIf="details.length === 0" class="text-center py-4 text-500">
                            <i class="pi pi-info-circle me-2"></i>
                            {{ 'product.noDetailsAdded' | translate }}
                        </div>
                    </ng-template>
                </p-accordionTab>

                <!-- SEO Panel -->
                <p-accordionTab [header]="'product.seoSettings' | translate">
                    <ng-template pTemplate="content">
                        <!-- SEO Title -->
                        <div class="field w-full mb-4">
                            <label class="font-semibold">{{ 'product.seoTitle' | translate }} *</label>
                            <ng-container formGroupName="seoTitle">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">{{ 'product.seoTitleEn' | translate }} *</label>
                                        <input pInputText formControlName="en" class="w-full"
                                            [placeholder]="'product.enterSeoTitleEn' | translate"
                                            [class.ng-invalid]="submitted && productForm.get('seoTitle.en')?.invalid" />
                                        <small class="text-red-500"
                                            *ngIf="submitted && productForm.get('seoTitle.en')?.invalid">
                                            {{ 'product.seoTitleEnRequired' | translate }}
                                        </small>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">{{ 'product.seoTitleAr' | translate }} *</label>
                                        <input pInputText formControlName="ar" class="w-full"
                                            [placeholder]="'product.enterSeoTitleAr' | translate"
                                            [class.ng-invalid]="submitted && productForm.get('seoTitle.ar')?.invalid" />
                                        <small class="text-red-500"
                                            *ngIf="submitted && productForm.get('seoTitle.ar')?.invalid">
                                            {{ 'product.seoTitleArRequired' | translate }}
                                        </small>
                                    </div>
                                </div>
                            </ng-container>
                        </div>

                        <!-- SEO Description -->
                        <div class="field w-full mb-4">
                            <label class="font-semibold">{{ 'product.seoDescription' | translate }} *</label>
                            <ng-container formGroupName="seoDescription">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">{{ 'product.seoDescriptionEn' | translate }} *</label>
                                        <textarea pTextarea formControlName="en" rows="3" class="w-full"
                                            [placeholder]="'product.enterSeoDescriptionEn' | translate"
                                            [class.ng-invalid]="submitted && productForm.get('seoDescription.en')?.invalid">
                                        </textarea>
                                        <small class="text-red-500"
                                            *ngIf="submitted && productForm.get('seoDescription.en')?.invalid">
                                            {{ 'product.seoDescriptionEnRequired' | translate }}
                                        </small>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">{{ 'product.seoDescriptionAr' | translate }} *</label>
                                        <textarea pTextarea formControlName="ar" rows="3" class="w-full"
                                            [placeholder]="'product.enterSeoDescriptionAr' | translate"
                                            [class.ng-invalid]="submitted && productForm.get('seoDescription.ar')?.invalid">
                                        </textarea>
                                        <small class="text-red-500"
                                            *ngIf="submitted && productForm.get('seoDescription.ar')?.invalid">
                                            {{ 'product.seoDescriptionArRequired' | translate }}
                                        </small>
                                    </div>
                                </div>
                            </ng-container>
                        </div>

                        <div class="field w-full mb-4">
                            <label for="seoKeywords" class="font-semibold">{{ 'product.seoKeywords' | translate }}</label>
                            <p-chips id="seoKeywords" styleClass="w-full" formControlName="seoKeywords"
                                [placeholder]="'product.addKeywords' | translate">
                            </p-chips>
                        </div>

                        <!-- SEO Image -->
                        <div class="field w-full">
                            <label class="font-semibold">{{ 'product.seoImage' | translate }}</label>
                            <p class="text-sm text-gray-600 mb-2">{{ 'product.seoImageHint' | translate }}</p>
                            <app-upload-files [index]="2" [control]="formControlSeoImage"
                                [filesServer]="productForm.get('seoImage')?.value" [multiple]="false" [accept]="'image/*'">
                            </app-upload-files>
                        </div>
                    </ng-template>
                </p-accordionTab>

            </p-accordion>
        </form>
        }
    </ng-template>

    <ng-template pTemplate="footer">
        <div class="flex justify-end gap-2">
            <p-button [label]="'common.cancel' | translate" severity="danger" icon="pi pi-times" (click)="hideDialog()">
            </p-button>
            <p-button [label]="'common.save' | translate" severity="success" icon="pi pi-check" [disabled]="productForm.invalid"
                (click)="saveProduct()">
            </p-button>
            <p-button [label]="'product.saveAndAddNew' | translate" severity="success" icon="pi pi-check" [disabled]="productForm.invalid"
            (click)="saveProduct(true)">
        </p-button>
        </div>
    </ng-template>
</p-dialog>

<p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>