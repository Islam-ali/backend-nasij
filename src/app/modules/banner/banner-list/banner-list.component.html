<div class="card">
    <p-toast></p-toast>
    <p-confirmDialog></p-confirmDialog>

    <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-900">{{ 'banner.manage' | translate }}</h2>
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
                <p-dropdown [options]="languages()" [ngModel]="currentLanguage()" (onChange)="onLanguageChange($event)"
                    optionLabel="label" optionValue="value" styleClass="w-32">
                </p-dropdown>
            </div>
            <p-button [label]="'banner.new' | translate" icon="pi pi-plus" (onClick)="openNew()"></p-button>
        </div>
    </div>

    <p-table [value]="banners()" [loading]="loading()" [paginator]="true" [rows]="10" [showCurrentPageReport]="true"
        [currentPageReportTemplate]="'banner.paging' | translate"
        [rowsPerPageOptions]="[10, 25, 50]" styleClass="p-datatable-sm">

        <ng-template pTemplate="header">
            <tr>
                <th>{{ 'banner.image' | translate }}</th>
                <th>{{ 'banner.tag' | translate }}</th>
                <th>{{ 'banner.title' | translate }}</th>
                <th>{{ 'banner.status' | translate }}</th>
                <th>{{ 'banner.buttons' | translate }}</th>
                <th>{{ 'common.actions' | translate }}</th>
            </tr>
        </ng-template>

        <ng-template pTemplate="body" let-banner>
            <tr>
                <td>
                    <img [src]="getImageUrl(banner.image.filePath)" [alt]="banner.title | multiLanguage:currentLanguage()"
                        class="w-16 h-16 object-cover rounded-lg">
                </td>
                <td>
                    <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                        {{ banner.tag | multiLanguage:currentLanguage() }}
                    </span>
                </td>
                <td>
                    <div>
                        <div class="font-semibold">{{ banner.title | multiLanguage:currentLanguage() }}</div>
                        <div class="text-sm text-gray-500">{{ banner.description | multiLanguage:currentLanguage() }}</div>
                    </div>
                </td>
                <td>
                    <p-toggleButton [ngModel]="banner.isActive" (onChange)="toggleActive(banner)" 
                        [onLabel]="'common.active' | translate"
                        [offLabel]="'common.inactive' | translate" 
                        [onIcon]="'pi pi-check'" [offIcon]="'pi pi-times'"
                        [styleClass]="banner.isActive ? 'p-button-success' : 'p-button-danger'">
                    </p-toggleButton>
                </td>
                <td>
                    <div class="flex flex-wrap gap-1">
                        <span *ngFor="let button of banner.buttons"
                            class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded">
                            {{ button.label | multiLanguage:currentLanguage() }}
                        </span>
                    </div>
                </td>
                <td>
                    <div class="flex gap-2">
                        <p-button icon="pi pi-pencil" styleClass="p-button-text p-button-sm"
                            (onClick)="editBanner(banner)">
                        </p-button>
                        <p-button icon="pi pi-trash" styleClass="p-button-text p-button-danger p-button-sm"
                            (onClick)="deleteBanner(banner)">
                        </p-button>
                    </div>
                </td>
            </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="6">
                    <div class="text-center py-8 text-gray-500 flex flex-col items-center justify-center">
                        <i class="pi pi-exclamation-triangle me-3" style="font-size: 2rem"></i>
                        <span>{{ 'banner.noData' | translate }}</span>
                    </div>
                </td>
            </tr>
        </ng-template>
    </p-table>

    <!-- Banner Dialog -->
    <p-dialog [(visible)]="bannerDialog" [style]="{width: '50rem'}" [modal]="true" [draggable]="false"
        [resizable]="false" [header]="banner() ? ('banner.dialogEdit' | translate) : ('banner.dialogNew' | translate)" [closable]="true" [closeOnEscape]="true">
        @if(bannerDialog) {
        <form [formGroup]="bannerForm" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <ng-container formGroupName="tag">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{ 'banner.tagEn' | translate }} *</label>
                    <input pInputText formControlName="en" class="w-full"
                        [class.ng-invalid]="bannerForm.get('tag.en')?.invalid && bannerForm.get('tag.en')?.touched"
                        [placeholder]="'banner.tagEnPlaceholder' | translate" />
                    <small *ngIf="bannerForm.get('tag.en')?.invalid && bannerForm.get('tag.en')?.touched"
                        class="text-red-500">{{ 'banner.tagEnRequired' | translate }}</small>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{ 'banner.tagAr' | translate }} *</label>
                    <input pInputText formControlName="ar" class="w-full"
                        [class.ng-invalid]="bannerForm.get('tag.ar')?.invalid && bannerForm.get('tag.ar')?.touched"
                        [placeholder]="'banner.tagArPlaceholder' | translate" />
                    <small *ngIf="bannerForm.get('tag.ar')?.invalid && bannerForm.get('tag.ar')?.touched"
                        class="text-red-500">{{ 'banner.tagArRequired' | translate }}</small>
                </div>
            </ng-container>
            </div>

            <ng-container formGroupName="title">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{ 'banner.titleEn' | translate }} *</label>
                    <input pInputText formControlName="en" class="w-full"
                        [class.ng-invalid]="bannerForm.get('title.en')?.invalid && bannerForm.get('title.en')?.touched"
                        [placeholder]="'banner.titleEnPlaceholder' | translate" />
                    <small *ngIf="bannerForm.get('title.en')?.invalid && bannerForm.get('title.en')?.touched"
                        class="text-red-500">{{ 'banner.titleEnRequired' | translate }}</small>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{ 'banner.titleAr' | translate }} *</label>
                    <input pInputText formControlName="ar" class="w-full"
                        [class.ng-invalid]="bannerForm.get('title.ar')?.invalid && bannerForm.get('title.ar')?.touched"
                        [placeholder]="'banner.titleArPlaceholder' | translate" />
                    <small *ngIf="bannerForm.get('title.ar')?.invalid && bannerForm.get('title.ar')?.touched"
                        class="text-red-500">{{ 'banner.titleArRequired' | translate }}</small>
                </div>
            </div>
            </ng-container>

            <ng-container formGroupName="description">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{ 'banner.descriptionEn' | translate }} *</label>
                    <textarea pInputTextarea formControlName="en" [rows]="3" class="w-full"
                        [class.ng-invalid]="bannerForm.get('description.en')?.invalid && bannerForm.get('description.en')?.touched"
                        [placeholder]="'banner.descriptionEnPlaceholder' | translate"></textarea>
                    <small
                        *ngIf="bannerForm.get('description.en')?.invalid && bannerForm.get('description.en')?.touched"
                        class="text-red-500">{{ 'banner.descriptionEnRequired' | translate }}</small>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{ 'banner.descriptionAr' | translate }} *</label>
                    <textarea pInputTextarea formControlName="ar" [rows]="3" class="w-full"
                        [class.ng-invalid]="bannerForm.get('description.ar')?.invalid && bannerForm.get('description.ar')?.touched"
                        [placeholder]="'banner.descriptionArPlaceholder' | translate"></textarea>
                    <small
                        *ngIf="bannerForm.get('description.ar')?.invalid && bannerForm.get('description.ar')?.touched"
                        class="text-red-500">{{ 'banner.descriptionArRequired' | translate }}</small>
                </div>
            </div>
            </ng-container>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{ 'common.status' | translate }}</label>
                    <p-toggleButton formControlName="isActive" [onLabel]="'common.active' | translate" [offLabel]="'common.inactive' | translate"
                        [onIcon]="'pi pi-check'" offIcon="pi pi-times">
                    </p-toggleButton>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">{{ 'banner.image' | translate }} *</label>
                <app-upload-files [control]="bannerForm.get('image')!" [filesServer]="bannerForm.get('image')?.value"
                    [accept]="'image/*'" [multiple]="false">
                </app-upload-files>
                <small *ngIf="bannerForm.get('image')?.invalid && bannerForm.get('image')?.touched"
                    class="text-red-500">{{ 'banner.imageRequired' | translate }}</small>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{ 'banner.startDate' | translate }}</label>
                    <p-calendar formControlName="startDate" [showIcon]="true" dateFormat="dd/mm/yy"
                        [placeholder]="'banner.selectStartDate' | translate">
                    </p-calendar>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{ 'banner.endDate' | translate }}</label>
                    <p-calendar formControlName="endDate" [showIcon]="true" dateFormat="dd/mm/yy"
                        [placeholder]="'banner.selectEndDate' | translate">
                    </p-calendar>
                </div>
            </div>

            <!-- Buttons Section -->
            <div>
                <div class="flex justify-between items-center mb-4">
                    <label class="block text-sm font-medium text-gray-700">{{ 'banner.buttons' | translate }}</label>
                    <p-button [label]="'banner.addButton' | translate" icon="pi pi-plus" size="small" styleClass="p-button-outlined"
                        (onClick)="addButton()">
                    </p-button>
                </div>

                <div formArrayName="buttons" class="space-y-4">
                    <div *ngFor="let buttonGroup of buttonsArray.controls; let i = index" [formGroupName]="i"
                        class="border border-gray-200 rounded-lg p-4 bg-gray-50">

                        <div class="flex justify-between items-start mb-4">
                            <h4 class="text-md font-semibold text-gray-900">{{ 'banner.button' | translate }} #{{ i + 1 }}</h4>
                            <p-button icon="pi pi-trash" size="small" styleClass="p-button-text p-button-danger"
                                (onClick)="removeButton(i)" [disabled]="buttonsArray.length === 1">
                            </p-button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <ng-container formGroupName="label">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">{{ 'banner.labelEn' | translate }} *</label>
                                <input pInputText formControlName="en" class="w-full"
                                    [class.ng-invalid]="buttonGroup.get('label.en')?.invalid && buttonGroup.get('label.en')?.touched"
                                    [placeholder]="'banner.labelEnPlaceholder' | translate" />
                                <small
                                    *ngIf="buttonGroup.get('label.en')?.invalid && buttonGroup.get('label.en')?.touched"
                                    class="text-red-500">{{ 'banner.labelEnRequired' | translate }}</small>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">{{ 'banner.labelAr' | translate }} *</label>
                                <input pInputText formControlName="ar" class="w-full"
                                    [class.ng-invalid]="buttonGroup.get('label.ar')?.invalid && buttonGroup.get('label.ar')?.touched"
                                    [placeholder]="'banner.labelArPlaceholder' | translate" />
                                <small
                                    *ngIf="buttonGroup.get('label.ar')?.invalid && buttonGroup.get('label.ar')?.touched"
                                    class="text-red-500">{{ 'banner.labelArRequired' | translate }}</small>
                            </div>
                        </ng-container>
                        </div>
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">{{ 'banner.url' | translate }} *</label>
                                <input pInputText formControlName="url" class="w-full"
                                    [class.ng-invalid]="buttonGroup.get('url')?.invalid && buttonGroup.get('url')?.touched"
                                    [placeholder]="'banner.urlPlaceholder' | translate" />
                                <small *ngIf="buttonGroup.get('url')?.invalid && buttonGroup.get('url')?.touched"
                                    class="text-red-500">{{ 'banner.urlRequired' | translate }}</small>
                            </div>
                        </div>


                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">{{ 'banner.queryParameters' | translate }}</label>

                            <!-- Query Parameter Name Selection -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="mb-3">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">{{ 'banner.parameterName' | translate }}</label>
                                    <p-dropdown [options]="params()" formControlName="queryParamName" optionLabel="name"
                                        optionValue="value" 
                                        class="w-full"
                                         [showClear]="true"
                                        [placeholder]="'banner.selectParameterName' | translate" appendTo="body"
                                        (onChange)="onparamsChange($event, i)">
                                    </p-dropdown>
                                </div>

                                <!-- Query Parameter Value Selection -->
                                <div class="mb-3" *ngIf="buttonGroup.get('queryParamName')?.value">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">{{ 'banner.parameterValue' | translate }}</label>
                                    <p-dropdown [options]="selectedQueryParamValues()[i] || []"
                                        formControlName="queryParamValue" optionLabel="name" optionValue="value"
                                        [filter]="true" [filterBy]="'name'" [filterPlaceholder]="'banner.searchValue' | translate"
                                        [showClear]="true" [placeholder]="'banner.selectValue' | translate" [appendTo]="'body'"
                                        (onChange)="onQueryParamValueChange($event, i)">
                                    </p-dropdown>
                                </div>
                            </div>
                            <!-- Add Button -->
                            <div class="mb-3"
                                *ngIf="buttonGroup.get('queryParamName')?.value && buttonGroup.get('queryParamValue')?.value">
                                <p-button [label]="'banner.addParameter' | translate" icon="pi pi-plus" size="small"
                                    styleClass="p-button-outlined p-button-sm"
                                    (onClick)="onQueryParamValueChange({value: buttonGroup.get('queryParamValue')?.value}, i)">
                                </p-button>
                            </div>

                            <!-- Display Current Query Parameters -->
                            <div *ngIf="buttonGroup.get('params')?.value && getparamsKeys(buttonGroup.get('params')?.value).length > 0"
                                class="mt-3">
                                <label class="block text-xs font-medium text-gray-600 mb-2">{{ 'banner.currentParameters' | translate }}:</label>
                                <div class="space-y-2">
                                    <div *ngFor="let param of getparamsKeys(buttonGroup.get('params')?.value)"
                                        class="flex items-center justify-between bg-gray-50 p-2 rounded">
                                        <span class="text-sm">
                                            <strong>{{param}}:</strong>
                                            {{buttonGroup.get('params')?.value[param]}}
                                        </span>
                                        <p-button icon="pi pi-times" size="small"
                                            styleClass="p-button-text p-button-danger p-button-sm"
                                            (onClick)="removeQueryParam(i, param)">
                                        </p-button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        }
        <ng-template pTemplate="footer">
            <div class="flex justify-end gap-2">
                <p-button [label]="'common.cancel' | translate" styleClass="p-button-text" (onClick)="hideDialog()">
                </p-button>
                <p-button [label]="'common.save' | translate" icon="pi pi-check" (onClick)="saveBanner()" [disabled]="bannerForm.invalid">
                </p-button>
            </div>
        </ng-template>
    </p-dialog>

    <!-- Delete Confirmation Dialog -->
    <p-dialog [visible]="deleteBannerDialog()" [style]="{width: '450px'}" [modal]="true" [draggable]="false"
        [resizable]="false" [header]="'common.confirm' | translate">

        <div class="confirmation-content">
            <i class="pi pi-exclamation-triangle me-3" style="font-size: 2rem"></i>
            <span *ngIf="banner()">{{ 'banner.confirmDelete' | translate: {title: (banner()?.title | multiLanguage:currentLanguage())} }}</span>
        </div>

        <ng-template pTemplate="footer">
            <div class="flex justify-end gap-2">
                <p-button [label]="'common.no' | translate" styleClass="p-button-text" (onClick)="deleteBannerDialog.set(false)">
                </p-button>
                <p-button [label]="'common.yes' | translate" icon="pi pi-check" styleClass="p-button-danger" (onClick)="confirmDelete()">
                </p-button>
            </div>
        </ng-template>
    </p-dialog>
</div>