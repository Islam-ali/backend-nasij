<div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800 p-6">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <!-- Toolbar -->
  <div class="mb-6 flex justify-between items-center">
    <div>
      <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-1">Product Features</h2>
      <p class="text-gray-600 dark:text-gray-400 text-sm">Manage product feature sections and configurations</p>
    </div>
    <p-button
      label="New Feature"
      icon="pi pi-plus"
      severity="success"
      [rounded]="true"
      [raised]="true"
      class="shadow-lg hover:shadow-xl transition-shadow duration-200"
      (click)="openNew()">
    </p-button>
  </div>

  <!-- Features Table -->
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden border border-gray-200 dark:border-gray-700">
    <p-table
      [value]="features"
      [tableStyle]="{ 'min-width': '50rem' }"
      styleClass="p-datatable-striped"
      [paginator]="true"
      [rows]="10"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
      [rowsPerPageOptions]="[10, 25, 50]"
      [paginator]="true"
      paginatorTemplate="FirstPageLink PrevPageLink PageLinks NextPageLink LastPageLink CurrentPageReport RowsPerPageDropdown">
      
      <ng-template pTemplate="header">
        <tr class="bg-gradient-to-r from-gray-100 to-gray-50 dark:from-gray-700 dark:to-gray-800 border-b-2 border-gray-200 dark:border-gray-600">
          <th class="p-4 text-left font-semibold text-gray-700 dark:text-gray-300">Order</th>
          <th class="p-4 text-left font-semibold text-gray-700 dark:text-gray-300">Title (EN)</th>
          <th class="p-4 text-left font-semibold text-gray-700 dark:text-gray-300">Title (AR)</th>
          <th class="p-4 text-left font-semibold text-gray-700 dark:text-gray-300">Limit</th>
          <th class="p-4 text-left font-semibold text-gray-700 dark:text-gray-300">Filters</th>
          <th class="p-4 text-left font-semibold text-gray-700 dark:text-gray-300">Status</th>
          <th class="p-4 text-center font-semibold text-gray-700 dark:text-gray-300">Actions</th>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="body" let-feature>
        <tr class="border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-150">
          <td class="p-4">
            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 font-semibold text-sm">
              {{ feature.displayOrder || '-' }}
            </span>
          </td>
          <td class="p-4 font-medium text-gray-900 dark:text-white">{{ feature.title.en }}</td>
          <td class="p-4 text-gray-700 dark:text-gray-300">{{ feature.title.ar || '-' }}</td>
          <td class="p-4">
            <span class="px-3 py-1 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-medium text-sm">
              {{ feature.limit }}
            </span>
          </td>
          <td class="p-4">
            <span class="inline-flex items-center px-3 py-1 rounded-full bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 font-medium text-sm border border-blue-200 dark:border-blue-800">
              <i class="pi pi-filter mr-2 text-xs"></i>
              {{ feature.filters?.length || 0 }} filter(s)
            </span>
          </td>
          <td class="p-4">
            <span [class]="'inline-flex items-center px-3 py-1 rounded-full font-medium text-sm ' + (feature.isActive ? 'bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300 border border-green-200 dark:border-green-800' : 'bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300 border border-red-200 dark:border-red-800')">
              <i [class]="'pi mr-2 text-xs ' + (feature.isActive ? 'pi-check-circle' : 'pi-times-circle')"></i>
              {{ feature.isActive ? 'Active' : 'Inactive' }}
            </span>
          </td>
          <td class="p-4">
            <div class="flex justify-center items-center gap-2">
              <p-button
                icon="pi pi-pencil"
                severity="info"
                [text]="true"
                [rounded]="true"
                [outlined]="true"
                class="hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors duration-150"
                pTooltip="Edit"
                tooltipPosition="top"
                (click)="editFeature(feature)">
              </p-button>
              <p-button
                icon="pi pi-trash"
                severity="danger"
                [text]="true"
                [rounded]="true"
                [outlined]="true"
                class="hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors duration-150"
                pTooltip="Delete"
                tooltipPosition="top"
                (click)="deleteFeature(feature)">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" class="p-8 text-center">
            <div class="flex flex-col items-center justify-center py-8">
              <i class="pi pi-inbox text-6xl text-gray-300 dark:text-gray-600 mb-4"></i>
              <p class="text-gray-500 dark:text-gray-400 text-lg font-medium">No features found</p>
              <p class="text-gray-400 dark:text-gray-500 text-sm mt-1">Click "New Feature" to create one</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <!-- Feature Dialog -->
  <p-dialog
    [(visible)]="featureDialog"
    [style]="{ width: '90vw', maxWidth: '1200px' }"
    [modal]="true"
    [header]="selectedFeature ? 'Edit Feature' : 'New Feature'"
    styleClass="p-fluid"
    [breakpoints]="{'960px': '95vw', '640px': '100vw'}"
    [draggable]="false"
    [resizable]="false">
    
    <form [formGroup]="featureForm" class="p-6">
      <div class="grid gap-4">
        <!-- Title Section -->
        <div class="col-12 md:col-6" formGroupName="title">
          <label for="titleEn" class="block mb-2 font-semibold text-gray-700 dark:text-gray-300">
            Title (English) <span class="text-red-500">*</span>
          </label>
          <input
            id="titleEn"
            type="text"
            pInputText
            formControlName="en"
            placeholder="e.g., Best Sellers"
            class="w-full border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 rounded-lg transition-all duration-200" />
          <small class="text-red-500 mt-1 block" *ngIf="submitted && featureForm.get('title.en')?.errors?.['required']">
            Title (English) is required
          </small>
        </div>

        <div class="col-12 md:col-6" formGroupName="title">
          <label for="titleAr" class="block mb-2 font-semibold text-gray-700 dark:text-gray-300">Title (Arabic)</label>
          <input
            id="titleAr"
            type="text"
            pInputText
            formControlName="ar"
            placeholder="مثال: الأكثر مبيعاً"
            class="w-full border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 rounded-lg transition-all duration-200" />
        </div>

        <!-- Description Section -->
        <div class="col-12 md:col-6" formGroupName="description">
          <label for="descEn" class="block mb-2 font-semibold text-gray-700 dark:text-gray-300">Description (English)</label>
          <textarea
            id="descEn"
            pInputTextarea
            [rows]="3"
            formControlName="en"
            placeholder="e.g., Our most popular products"
            class="w-full border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 rounded-lg resize-none transition-all duration-200"></textarea>
        </div>

        <div class="col-12 md:col-6" formGroupName="description">
          <label for="descAr" class="block mb-2 font-semibold text-gray-700 dark:text-gray-300">Description (Arabic)</label>
          <textarea
            id="descAr"
            pInputTextarea
            [rows]="3"
            formControlName="ar"
            placeholder="مثال: منتجاتنا الأكثر شعبية"
            class="w-full border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 rounded-lg resize-none transition-all duration-200"></textarea>
        </div>

        <!-- Limit -->
        <div class="col-12 md:col-3">
          <label for="limit" class="block mb-2 font-semibold text-gray-700 dark:text-gray-300">
            Number of Products <span class="text-red-500">*</span>
          </label>
          <p-inputNumber
            id="limit"
            formControlName="limit"
            [min]="1"
            [showButtons]="true"
            placeholder="10"
            styleClass="w-full">
          </p-inputNumber>
          <small class="text-red-500 mt-1 block" *ngIf="submitted && featureForm.get('limit')?.errors?.['required']">
            Limit is required
          </small>
        </div>

        <!-- Display Order -->
        <div class="col-12 md:col-3">
          <label for="displayOrder" class="block mb-2 font-semibold text-gray-700 dark:text-gray-300">Display Order</label>
          <p-inputNumber
            id="displayOrder"
            formControlName="displayOrder"
            [showButtons]="true"
            placeholder="1"
            styleClass="w-full">
          </p-inputNumber>
        </div>

        <!-- Is Active -->
        <div class="col-12 md:col-3">
          <label for="isActive" class="block mb-2 font-semibold text-gray-700 dark:text-gray-300">Active Status</label>
          <div class="flex items-center h-10">
            <p-toggleSwitch id="isActive" formControlName="isActive"></p-toggleSwitch>
            <span class="ml-3 text-sm text-gray-600 dark:text-gray-400">
              {{ featureForm.get('isActive')?.value ? 'Active' : 'Inactive' }}
            </span>
          </div>
        </div>
      </div>

      <!-- Sorting -->
      <div class="mt-6 p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200 flex items-center">
          <i class="pi pi-sort-alt mr-2 text-blue-500"></i>
          Sorting Configuration
        </h3>
        <div class="grid gap-4" formGroupName="sorting">
          <div class="col-12 md:col-6">
            <label for="sortField" class="block mb-2 font-semibold text-gray-700 dark:text-gray-300">
              Sort By <span class="text-red-500">*</span>
            </label>
            <p-dropdown
              id="sortField"
              formControlName="field"
              [options]="sortFieldOptions"
              optionLabel="label"
              optionValue="value"
              placeholder="Select field"
              styleClass="w-full">
            </p-dropdown>
          </div>
          <div class="col-12 md:col-6">
            <label for="sortOrder" class="block mb-2 font-semibold text-gray-700 dark:text-gray-300">
              Order <span class="text-red-500">*</span>
            </label>
            <p-dropdown
              id="sortOrder"
              formControlName="order"
              [options]="sortOrderOptions"
              optionLabel="label"
              optionValue="value"
              placeholder="Select order"
              styleClass="w-full">
            </p-dropdown>
          </div>
        </div>
      </div>

      <!-- Dynamic Filters -->
      <div class="mt-6 p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 flex items-center">
            <i class="pi pi-filter mr-2 text-blue-500"></i>
            Dynamic Filters
          </h3>
          <p-button
            label="Add Filter"
            icon="pi pi-plus"
            severity="secondary"
            size="small"
            [rounded]="true"
            [outlined]="true"
            class="shadow-md hover:shadow-lg transition-shadow duration-200"
            (click)="addFilter()">
          </p-button>
        </div>

        <div formArrayName="filters">
          @for (filter of filtersArray.controls; track $index; let i = $index) {
            <div [formGroupName]="i" class="grid gap-4 p-4 mb-4 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 shadow-sm hover:shadow-md transition-shadow duration-200">
              <div class="col-12 md:col-4">
                <label class="block mb-2 font-semibold text-gray-700 dark:text-gray-300">
                  Field <span class="text-red-500">*</span>
                </label>
                <p-dropdown
                  formControlName="field"
                  [options]="filterFieldOptions"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Select field"
                  styleClass="w-full">
                </p-dropdown>
              </div>

              <div class="col-12 md:col-3">
                <label class="block mb-2 font-semibold text-gray-700 dark:text-gray-300">
                  Operator <span class="text-red-500">*</span>
                </label>
                <p-dropdown
                  formControlName="operator"
                  [options]="operatorOptions"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Select operator"
                  styleClass="w-full">
                </p-dropdown>
              </div>

              <div class="col-12 md:col-4">
                <label class="block mb-2 font-semibold text-gray-700 dark:text-gray-300">Value</label>
                
                <!-- Category Dropdown -->
                @if (getFieldType(i) === 'category') {
                  <p-dropdown
                    formControlName="value"
                    [options]="getCategoryOptions()"
                    optionLabel="label"
                    optionValue="value"
                    placeholder="Select Category"
                    [filter]="true"
                    [style]="{'width': '100%'}">
                  </p-dropdown>
                }
                
                <!-- Brand Dropdown -->
                @else if (getFieldType(i) === 'brand') {
                  <p-dropdown
                    formControlName="value"
                    [options]="getBrandOptions()"
                    optionLabel="label"
                    optionValue="value"
                    placeholder="Select Brand"
                    [filter]="true"
                    [style]="{'width': '100%'}">
                  </p-dropdown>
                }
                
                <!-- Boolean Dropdown -->
                @else if (getFieldType(i) === 'boolean') {
                  <p-dropdown
                    formControlName="value"
                    [options]="getBooleanOptions()"
                    optionLabel="label"
                    optionValue="value"
                    placeholder="Select Value"
                    [style]="{'width': '100%'}">
                  </p-dropdown>
                }
                
                <!-- Text Input (Default) -->
                @else {
                  <input
                    type="text"
                    pInputText
                    formControlName="value"
                    placeholder="e.g., 507f1f77bcf86cd799439011"
                    class="w-full border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 rounded-lg transition-all duration-200" />
                  <small class="text-gray-500 dark:text-gray-400 text-xs mt-1 block">For 'in' operator, use comma-separated values</small>
                }
              </div>

              <div class="col-12 md:col-1 flex items-end">
                <p-button
                  icon="pi pi-trash"
                  severity="danger"
                  [text]="true"
                  [rounded]="true"
                  [outlined]="true"
                  class="hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors duration-150"
                  pTooltip="Remove filter"
                  tooltipPosition="top"
                  (click)="removeFilter(i)">
                </p-button>
              </div>
            </div>
          }
          @empty {
            <div class="text-center p-8 bg-white dark:bg-gray-700 rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-600">
              <i class="pi pi-filter text-4xl text-gray-300 dark:text-gray-600 mb-3"></i>
              <p class="text-gray-500 dark:text-gray-400 font-medium">No filters added</p>
              <p class="text-gray-400 dark:text-gray-500 text-sm mt-1">Click "Add Filter" to create one</p>
            </div>
          }
        </div>
      </div>

      <!-- Preview Button -->
      <div class="mt-6 flex justify-center">
        <p-button
          label="Preview Products"
          icon="pi pi-eye"
          severity="help"
          [rounded]="true"
          [raised]="true"
          [disabled]="featureForm.invalid"
          class="shadow-lg hover:shadow-xl transition-shadow duration-200 disabled:opacity-50"
          (click)="previewFeature()">
        </p-button>
      </div>

      <!-- Preview Results -->
      @if (showPreview) {
        <div class="mt-6 p-6 bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-xl border-2 border-blue-200 dark:border-blue-800 shadow-lg">
          <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200 flex items-center">
            <i class="pi pi-eye mr-2 text-blue-500"></i>
            Preview Results 
            <span class="ml-2 px-3 py-1 bg-blue-500 text-white rounded-full text-sm font-bold">
              {{ previewProducts.length }} product(s)
            </span>
          </h3>
          @if (previewProducts.length > 0) {
            <div class="grid gap-4">
              @for (product of previewProducts; track product._id) {
                <div class="col-12 md:col-3">
                  <div class="bg-white dark:bg-gray-800 rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-shadow duration-200 border border-gray-200 dark:border-gray-700">
                    <div class="relative overflow-hidden">
                      <img
                        [src]="getImageUrl(product.images[0].filePath)"
                        [alt]="product.name.en"
                        class="w-full h-40 object-cover hover:scale-110 transition-transform duration-300" />
                      <div class="absolute top-2 right-2">
                        <span class="px-2 py-1 bg-blue-500 text-white text-xs font-semibold rounded-full shadow-lg">
                          Preview
                        </span>
                      </div>
                    </div>
                    <div class="p-3">
                      <p class="font-semibold text-sm mb-2 text-gray-900 dark:text-white line-clamp-2">
                        {{ product.name.en }}
                      </p>
                      <p class="text-blue-600 dark:text-blue-400 font-bold text-lg">
                        {{ product.price | currency:'USD' }}
                      </p>
                    </div>
                  </div>
                </div>
              }
            </div>
          } @else {
            <div class="text-center py-8">
              <i class="pi pi-inbox text-5xl text-gray-300 dark:text-gray-600 mb-3"></i>
              <p class="text-gray-500 dark:text-gray-400 font-medium">No products found</p>
              <p class="text-gray-400 dark:text-gray-500 text-sm mt-1">Try adjusting your filters</p>
            </div>
          }
        </div>
      }
    </form>

    <ng-template pTemplate="footer">
      <div class="flex justify-end gap-3">
        <p-button
          label="Cancel"
          icon="pi pi-times"
          severity="secondary"
          [text]="true"
          [rounded]="true"
          class="hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-150"
          (click)="hideDialog()">
        </p-button>
        <p-button
          label="Save"
          icon="pi pi-check"
          severity="success"
          [rounded]="true"
          [raised]="true"
          class="shadow-md hover:shadow-lg transition-shadow duration-200"
          (click)="saveFeature()">
        </p-button>
      </div>
    </ng-template>
  </p-dialog>
</div>


