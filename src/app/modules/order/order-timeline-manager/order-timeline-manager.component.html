<div class="order-timeline-manager">
  <!-- Timeline Display -->
  <app-order-timeline [orderId]="orderId" [refreshTrigger]="timelineRefreshTrigger"></app-order-timeline>

  <!-- Action Buttons -->
  <div class="timeline-actions">
    <div class="btn-group" role="group">
      <p-button  
        type="button" 
        severity="primary"
        [rounded]="true"
        [outlined]="true"
        (click)="addExistingTimelineToOrder()"
        [disabled]="loading || availableTimelines.length === 0">
        <i class="fas fa-plus me-2"></i>
        Add Timeline to Order
      </p-button>
      <p-button 
        type="button" 
        severity="secondary"
        [rounded]="true"
        [outlined]="true"
        (click)="createNewTimeline()">
        <i class="fas fa-clock me-2"></i>
        Create New Timeline
      </p-button>
    </div>
    
    <!-- Available Timelines Count -->
    <div class="timeline-info">
      <small class="text-muted">
        <i class="fas fa-info-circle me-1"></i>
        {{ availableTimelines.length }} timeline{{ availableTimelines.length !== 1 ? 's' : '' }} available
      </small>
    </div>
  </div>

  <!-- Error Display -->
  <div *ngIf="error" class="alert alert-warning mt-3">
    <i class="fas fa-exclamation-triangle me-2"></i>
    {{ error }}
    <button 
      type="button" 
      class="btn btn-sm btn-outline-warning ms-2"
      (click)="loadAvailableTimelines()">
      Retry
    </button>
  </div>

  <!-- Timeline Form -->
  <div *ngIf="showTimelineForm" class="timeline-form-section">
    <app-timeline-form
      [orderId]="orderId"
      [availableTimelines]="availableTimelines"
      (timelineCreated)="onTimelineCreated($event)"
      (timelineUpdated)="onTimelineUpdated($event)"
      (timelineAddedToOrder)="onTimelineAddedToOrder()"
      (formCancelled)="onFormCancelled()">
    </app-timeline-form>
  </div>

  <!-- PrimeNG Timeline List Table -->
  <div class="timeline-list">
    <p-table [value]="availableTimelines" [loading]="loading" [paginator]="true" [rows]="10" 
             [showCurrentPageReport]="true" currentPageReportTemplate="Showing {first} to {last} of {totalRecords} timelines"
             styleClass="p-datatable-sm">
      <ng-template pTemplate="header">
        <tr>
          <th>Name (EN)</th>
          <th>Name (AR)</th>
          <th>Icon</th>
          <th>Date & Time</th>
          <th>Actions</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-timeline>
        <tr>
          <td>{{ timeline.name.en }}</td>
          <td>{{ timeline.name.ar }}</td>
          <td>
            <span class="timeline-icon">{{ getTimelineIcon(timeline.icon) }}</span>
            <small class="text-muted ms-2">{{ timeline.icon }}</small>
          </td>
          <td>{{ formatDateTime(timeline.dateTime) }}</td>
          <td>
            <div class="action-buttons">
              <p-button 
                icon="pi pi-pencil" 
                [rounded]="true" 
                [outlined]="true" 
                severity="info"
                size="small"
                [disabled]="loading"
                (click)="editTimeline(timeline)"
                pTooltip="Edit Timeline">
              </p-button>
              <p-button 
                icon="pi pi-trash" 
                [rounded]="true" 
                [outlined]="true" 
                severity="danger"
                size="small"
                [disabled]="loading"
                (click)="deleteTimeline(timeline)"
                pTooltip="Delete Timeline"
                class="ms-2">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="5" class="text-center py-4">
            <div class="empty-state">
              <i class="pi pi-clock text-muted" style="font-size: 3rem;"></i>
              <h5 class="mt-3 text-muted">No Timelines Found</h5>
              <p class="text-muted">Create your first timeline to get started.</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <!-- Edit Timeline Dialog -->
  <p-dialog 
    header="Edit Timeline" 
    [(visible)]="showEditDialog" 
    [modal]="true" 
    [style]="{width: '600px'}"
    [closable]="true"
    (onHide)="onEditDialogClose()">
    <app-timeline-form
      [editTimeline]="selectedTimeline || undefined"
      [isDialogMode]="true"
      (timelineUpdated)="onTimelineUpdated($event)"
      (formCancelled)="onEditDialogClose()">
    </app-timeline-form>
  </p-dialog>

  <!-- Toast Messages -->
  <p-toast></p-toast>

  <!-- Confirmation Dialog -->
  <p-confirmDialog></p-confirmDialog>

</div>