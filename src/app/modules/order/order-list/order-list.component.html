<!-- Header with title and actions -->
<p-toast></p-toast>
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
                <i class="pi pi-shopping-cart mr-3 text-blue-600"></i>
                Order Management
            </h1>
            <p class="text-gray-600 dark:text-gray-400">
                Manage and track all customer orders efficiently
            </p>
        </div>
        <div class="flex flex-col sm:flex-row gap-3">
            <p-button severity="success" label="Create New Order" icon="pi pi-plus" size="large" (click)="openNew()"
                styleClass="p-button-raised">
            </p-button>
            <!-- <p-button severity="secondary" label="Export Orders" icon="pi pi-download" size="large"
                [loading]="loadingExportSignal()" (click)="exportOrders()" styleClass="p-button-outlined">
            </p-button> -->
        </div>
    </div>
</div>

<!-- Order Table -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
    <p-table #dt [value]="orders()" [loading]="loading()"
        [globalFilterFields]="['orderNumber', 'customer.name', 'status', 'paymentStatus']"
        [tableStyle]="{'min-width': '75rem'}" dataKey="_id"
        styleClass="p-datatable-striped">
        <ng-template pTemplate="caption">
            <div
                class="flex flex-col md:flex-row md:justify-between md:items-center gap-4 p-6 border-b border-gray-200 dark:border-gray-700">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-1">Orders List</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        Total: {{ pagination().total }} orders
                    </p>
                </div>
                <div class="flex flex-col sm:flex-row gap-3">
                    <p-iconField iconPosition="left" class="w-full sm:w-80">
                        <p-inputIcon>
                            <i class="pi pi-search"></i>
                        </p-inputIcon>
                        <input pInputText type="text" (input)="onGlobalFilter(dt, $event)"
                            placeholder="Search orders by number, customer, status..." class="w-full" />
                    </p-iconField>
                    <p-button icon="pi pi-filter" severity="secondary" [outlined]="true" (click)="toggleFilters()"
                        [label]="showFilters() ? 'Hide Filters' : 'Show Filters'">
                    </p-button>
                </div>
            </div>
        </ng-template>
        <ng-template pTemplate="header">
            <tr class="bg-gray-50 dark:bg-gray-700">
                <!-- <th class="text-center p-4 font-semibold text-gray-700 dark:text-gray-300" style="width: 3rem">
                    <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                </th> -->
                <th class="text-left p-4 font-semibold text-gray-700 dark:text-gray-300">
                    <i class="pi pi-hashtag mr-2"></i>Order #
                </th>
                <th class="text-left p-4 font-semibold text-gray-700 dark:text-gray-300">
                    <i class="pi pi-user mr-2"></i>Customer
                </th>
                <th class="text-right p-4 font-semibold text-gray-700 dark:text-gray-300">
                    <i class="pi pi-dollar mr-2"></i>Total
                </th>
                <th class="text-center p-4 font-semibold text-gray-700 dark:text-gray-300">
                    <i class="pi pi-info-circle mr-2"></i>Status
                </th>
                <th class="text-center p-4 font-semibold text-gray-700 dark:text-gray-300">
                    <i class="pi pi-credit-card mr-2"></i>Payment
                </th>
                <th class="text-center p-4 font-semibold text-gray-700 dark:text-gray-300">
                    <i class="pi pi-calendar mr-2"></i>Date
                </th>
                <th class="text-center p-4 font-semibold text-gray-700 dark:text-gray-300">
                    <i class="pi pi-cog mr-2"></i>Actions
                </th>
            </tr>
        </ng-template>
        <!-- <tr>
            <th></th>
            <th>
                <p-columnFilter type="text" field="orderNumber"></p-columnFilter>
                <input pInputText type="text" (input)="filterOrders($event, 'orderNumber')" class="w-full">
            </th>
            <th>
                <p-columnFilter type="text" field="customer.name"></p-columnFilter>
                <input pInputText type="text" (input)="filterOrders($event, 'customer.name')" class="w-full">
            </th>
            <th colspan="4"></th>
            <th>
                <button pButton pRipple type="button" icon="pi pi-filter-slash" class="p-button-outlined"
                    (click)="dt.clear()"></button>
            </th>
        </tr> -->

        <ng-template pTemplate="body" let-order>
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                <!-- <td class="text-center p-4">
                    <p-tableCheckbox [value]="order"></p-tableCheckbox>
                </td> -->
                <td class="p-4">
                    <div class="flex items-center">
                        <div
                            class="w-8 h-8 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center mr-3">
                            <i class="pi pi-shopping-cart text-blue-600 dark:text-blue-400 text-sm"></i>
                        </div>
                        <div>
                            <div class="font-semibold text-gray-900 dark:text-white">#{{ order.orderNumber }}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">{{ order._id?.slice(-8) }}</div>
                        </div>
                    </div>
                </td>
                <td class="p-4">
                    <div class="flex items-center">
                        <div
                            class="w-8 h-8 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center mr-3">
                            <i class="pi pi-user text-green-600 dark:text-green-400 text-sm"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-900 dark:text-white">
                                {{ order.shippingAddress?.fullName || 'Unknown Customer' }}
                            </div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">
                                {{ order.shippingAddress?.phone || 'No phone' }}
                            </div>
                        </div>
                    </div>
                </td>
                <td class="p-4 text-right">
                    <div class="font-bold text-lg text-gray-900 dark:text-white">
                        {{ order.total | currency:'USD':'symbol':'1.2-2' }}
                    </div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">
                        {{ order.items?.length || 0 }} items
                    </div>
                </td>
                <td class="p-4 text-center">
                    <p-tag [value]="order.orderStatus | titlecase" [severity]="getSeverity(order.orderStatus)"
                        styleClass="px-3 py-1">
                    </p-tag>
                </td>
                <td class="p-4 text-center">
                    <div class="flex flex-col items-center gap-1">
                        <p-tag [value]="order.paymentStatus | titlecase"
                            [severity]="getPaymentSeverity(order.paymentStatus)" styleClass="px-2 py-1 text-xs">
                        </p-tag>
                        <p-tag [value]="order.paymentMethod | titlecase"
                            [severity]="getPaymentMethodSeverity(order.paymentMethod)" styleClass="px-2 py-1 text-xs">
                        </p-tag>
                    </div>
                </td>
                <td class="p-4 text-center">
                    <div class="text-sm font-medium text-gray-900 dark:text-white">
                        {{ order.createdAt | date:'MMM dd, yyyy' }}
                    </div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">
                        {{ order.createdAt | date:'HH:mm' }}
                    </div>
                </td>
                <td class="p-4 text-center">
                    <div class="flex justify-center gap-2">
                        <!-- <p-button icon="pi pi-eye" [rounded]="true" [outlined]="true" severity="info" size="small"
                            pTooltip="View Details" (click)="viewOrderDetails(order)">
                        </p-button> -->
                        <!-- Timeline button removed -->
                        <p-button icon="pi pi-pencil" [rounded]="true" [outlined]="true" severity="success" size="small"
                            pTooltip="Edit Order" (click)="editOrder(order)">
                        </p-button>
                        <p-button icon="pi pi-trash" [rounded]="true" [outlined]="true" severity="danger" size="small"
                            pTooltip="Delete Order" (click)="deleteOrder(order)">
                        </p-button>
                    </div>
                </td>
            </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="7" class="text-center py-12">
                    <div class="flex flex-col items-center justify-center gap-4">
                        <div
                            class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center">
                            <i class="pi pi-shopping-cart text-2xl text-gray-400"></i>
                        </div>
                        <div class="text-center">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">No orders found</h3>
                            <p class="text-gray-500 dark:text-gray-400 mb-4">
                                Start by creating your first order or adjust your search criteria.
                            </p>
                            <p-button label="Create New Order" icon="pi pi-plus" severity="success" (click)="openNew()">
                            </p-button>
                        </div>
                    </div>
                </td>
            </tr>
        </ng-template>
        <ng-template pTemplate="footer">
            <td colspan="7">
            <div
                class="flex justify-center items-center gap-4 p-4 bg-gray-50 dark:bg-gray-700 border-t border-gray-200 dark:border-gray-600">

                <p-paginator [rows]="pagination().limit" [appendTo]="'body'" [totalRecords]="pagination().total"
                     (onPageChange)="onPageChange($event)"
                    [showCurrentPageReport]="false" [rowsPerPageOptions]="[10, 25, 50]" styleClass="p-paginator-sm">
                </p-paginator>
            </div>
        </td>
        </ng-template>
    </p-table>
</div>

<!-- Order Dialog -->
<p-dialog [(visible)]="orderDialog" [style]="{width: '90vw', maxWidth: '1200px'}"
    [header]="orderForm.get('_id')?.value ? 'Edit Order' : 'Create New Order'" [modal]="true" [closable]="true"
    [resizable]="true" [draggable]="true" [dismissableMask]="true"
    [contentStyle]="{'max-height': '90vh', 'padding': '0'}" [styleClass]="'order-dialog'">
    @if(orderDialog){
    <div class="p-6">
        <form [formGroup]="orderForm" class="space-y-6">
            <!-- Order Header -->
            <div
                class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-lg p-6 mb-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center">
                        <i class="pi pi-shopping-cart text-blue-600 dark:text-blue-400"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">Order Information</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Basic order details and status</p>
                    </div>
                </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- <div class="field">
                <label for="orderNumber">Order #</label>
                <input id="orderNumber" pInputText formControlName="orderNumber"
                    [class.p-invalid]="submitted && orderForm.get('orderNumber')?.invalid">
                <small class="p-error" *ngIf="submitted && orderForm.get('orderNumber')?.invalid">Order number is
                    required</small>
            </div> -->

                    <div class="space-y-2">
                        <label for="orderStatus" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            <i class="pi pi-info-circle mr-2"></i>Order Status
                        </label>
                        <p-dropdown id="orderStatus" [options]="statusOptions" formControlName="orderStatus"
                            optionLabel="label" optionValue="value" [style]="{'width':'100%'}"
                            placeholder="Select status" styleClass="w-full">
                        </p-dropdown>
                    </div>

                    <div class="space-y-2">
                        <label for="paymentStatus" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            <i class="pi pi-credit-card mr-2"></i>Payment Status
                        </label>
                        <p-dropdown id="paymentStatus" [options]="paymentStatusOptions" formControlName="paymentStatus"
                            optionLabel="label" optionValue="value" [style]="{'width':'100%'}"
                            placeholder="Select payment status" styleClass="w-full">
                        </p-dropdown>
                    </div>

                        <!-- Tracking Status -->
                        <div class="space-y-2">
                            <label for="trackingStatus" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                <i class="pi pi-truck mr-2"></i>Tracking Status
                            </label>
                            <p-dropdown id="trackingStatus" [options]="trackingStatusOptions" formControlName="trackingStatus"
                                optionLabel="label" optionValue="value" [style]="{'width':'100%'}"
                                placeholder="Select tracking status" styleClass="w-full">
                            </p-dropdown>
                        </div>

                    <div class="space-y-2">
                        <label for="paymentMethod" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            <i class="pi pi-wallet mr-2"></i>Payment Method
                        </label>
                        <p-dropdown id="paymentMethod" [options]="paymentMethodOptions" formControlName="paymentMethod"
                            optionLabel="label" optionValue="value" [style]="{'width':'100%'}"
                            placeholder="Select payment method" styleClass="w-full">
                        </p-dropdown>
                    </div>
                </div>
            </div>

            <!-- Payment Image Display -->
            <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-4"
                *ngIf="orderForm.get('paymentMethod')?.value === 'vodafone_cash' && orderForm.get('paymentImage')?.value">
                <div class="flex items-center gap-3 mb-3">
                    <i class="pi pi-image text-yellow-600 dark:text-yellow-400"></i>
                    <h4 class="font-semibold text-yellow-800 dark:text-yellow-200">Payment Screenshot</h4>
                </div>
                <div class="flex items-center gap-4">
                    <img [src]="orderForm.get('paymentImage')?.value" alt="Payment Screenshot"
                        class="w-24 h-24 object-cover rounded-lg border-2 border-yellow-200 dark:border-yellow-700 cursor-pointer"
                        (click)="viewPaymentImage(orderForm.get('paymentImage')?.value)">
                    <div class="text-sm text-yellow-700 dark:text-yellow-300">
                        <p class="font-medium">Vodafone Cash Payment</p>
                        <p class="text-xs">Click to view full size</p>
                    </div>
                </div>
            </div>


    <!-- Shipping Address Section -->
    <div
        class="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-lg p-6">
        <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center">
                <i class="pi pi-map-marker text-green-600 dark:text-green-400"></i>
            </div>
            <div>
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">Shipping Address</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">Customer delivery information</p>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" formGroupName="shippingAddress">
            <div class="space-y-2">
                <label for="fullName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                    <i class="pi pi-user mr-2"></i>Full Name *
                </label>
                <input id="fullName" pInputText formControlName="fullName" placeholder="Enter customer full name"
                    class="w-full" [class.p-invalid]="submitted && orderForm.get('shippingAddress.fullName')?.invalid">
                <small class="p-error" *ngIf="submitted && orderForm.get('shippingAddress.fullName')?.invalid">
                    Full name is required
                </small>
            </div>
            <div class="field">
                <label for="phone">Phone</label>
                <input id="phone" class="w-full" pInputText formControlName="phone"
                    [class.p-invalid]="submitted && orderForm.get('shippingAddress.phone')?.invalid">
                <small class="p-error" *ngIf="submitted && orderForm.get('shippingAddress.phone')?.invalid">Phone is
                    required</small>
            </div>

            <div class="field col-12">
                <label for="country">Country</label>
                <p-dropdown id="country" styleClass="w-full" [options]="countryOptions()" formControlName="country" optionLabel="name.en"
                    optionValue="_id" [style]="{'width':'100%'}" (onChange)="loadStates()">
                </p-dropdown>
                <small class="p-error" *ngIf="submitted && orderForm.get('shippingAddress.country')?.invalid">Country is
                    required</small>
            </div>
            <!-- set shipping cost based on state -->
            <div class="field">
                <label for="state">State</label>
                <p-dropdown id="state" styleClass="w-full" [options]="stateOptions()" formControlName="state" optionLabel="name.en"
                    optionValue="_id" [style]="{'width':'100%'}" (onChange)="setShippingCost()">
                </p-dropdown>
                <small class="p-error" *ngIf="submitted && orderForm.get('shippingAddress.state')?.invalid">State is
                    required</small>
            </div>

            <div class="field">
                <label for="address">address</label>
                <input id="address" pInputText  class="w-full" formControlName="address"
                    [class.p-invalid]="submitted && orderForm.get('shippingAddress.address')?.invalid">
                <small class="p-error" *ngIf="submitted && orderForm.get('shippingAddress.address')?.invalid">address
                    is
                    required</small>
            </div>
            <div class="field">
                <label for="city">City</label>
                <input id="city" pInputText class="w-full" formControlName="city"
                    [class.p-invalid]="submitted && orderForm.get('shippingAddress.city')?.invalid">
                <small class="p-error" *ngIf="submitted && orderForm.get('shippingAddress.city')?.invalid">City
                    is required</small>
            </div>


        </div>
    </div>

    <!-- Order Items Section -->
    <div class="bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 rounded-lg p-6">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-purple-100 dark:bg-purple-900 rounded-full flex items-center justify-center">
                    <i class="pi pi-shopping-bag text-purple-600 dark:text-purple-400"></i>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white">Order Items</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        Products and packages in this order
                        <span class="ml-2 px-2 py-1 bg-purple-100 dark:bg-purple-800 text-purple-800 dark:text-purple-200 rounded-full text-xs font-semibold">
                            {{ items.length }} {{ items.length === 1 ? 'Item' : 'Items' }}
                        </span>
                    </p>
                </div>
            </div>
            <p-button icon="pi pi-plus" label="Add Item" severity="success" size="large" (click)="addItem()"
                styleClass="p-button-raised shadow-lg hover:shadow-xl transition-shadow">
            </p-button>
        </div>

        <!-- Items Cards -->
        <div class="space-y-4 max-h-[600px] overflow-y-auto pr-2">
            <ng-container *ngFor="let item of items.controls; let rowIndex = index">
            <div [formGroup]="$any(item)"
                class="bg-white dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden">
                
                <!-- Item Header -->
                <div class="bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-700 dark:to-gray-800 px-6 py-4 border-b border-gray-200 dark:border-gray-600">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-purple-100 dark:bg-purple-900 rounded-lg flex items-center justify-center">
                                <i class="pi pi-tag text-purple-600 dark:text-purple-400 text-lg"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-900 dark:text-white text-lg">
                                    Item #{{ rowIndex + 1 }}
                                </h4>
                                <p class="text-sm text-gray-500 dark:text-gray-400">
                                    {{ item.get('itemType')?.value === 'Package' ? 'Package Deal' : 'Single Product' }}
                                </p>
                            </div>
                        </div>
                        <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [outlined]="true"
                            size="large" pTooltip="Remove Item" tooltipPosition="left" 
                            (click)="removeItem(rowIndex)"
                            styleClass="hover:scale-110 transition-transform">
                        </p-button>
                    </div>
                </div>

                <!-- Item Body -->
                <div class="p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        
                        <!-- Left Column -->
                        <div class="space-y-4">
                            <!-- Type Selection -->
                            <div class="space-y-2">
                                <label class="flex items-center text-sm font-semibold text-gray-700 dark:text-gray-300">
                                    <i class="pi pi-tag mr-2 text-purple-600"></i>
                                    Item Type *
                                </label>
                                <p-dropdown formControlName="itemType" 
                                    [options]="[
                                        {label: 'ðŸ“¦ Package', value: 'Package'},
                                        {label: 'ðŸ›ï¸ Product', value: 'Product'}
                                    ]" 
                                    appendTo="body" 
                                    optionLabel="label" 
                                    optionValue="value"
                                    placeholder="Select Type" 
                                    styleClass="w-full"
                                    [class.p-invalid]="submitted && item.get('itemType')?.invalid"
                                    (onChange)="onItemChange($event, rowIndex)">
                                </p-dropdown>
                                <small class="p-error" *ngIf="submitted && item.get('itemType')?.invalid">
                                    Item type is required
                                </small>
                            </div>

                            <!-- Item Selection -->
                            <div class="space-y-2">
                                <label class="flex items-center text-sm font-semibold text-gray-700 dark:text-gray-300">
                                    <i class="pi pi-box mr-2 text-blue-600"></i>
                                    Select {{ item.get('itemType')?.value === 'Package' ? 'Package' : 'Product' }} *
                                </label>
                                <p-dropdown formControlName="itemId"
                                    [options]="item.get('itemType')?.value === 'Package' ? packages() : products()"
                                    appendTo="body" 
                                    optionLabel="name.en" 
                                    optionValue="_id" 
                                    placeholder="Search and select..."
                                    styleClass="w-full" 
                                    [filter]="true" 
                                    filterBy="name.en,name.ar"
                                    [class.p-invalid]="submitted && item.get('itemId')?.invalid"
                                    (onChange)="onItemChange($event,rowIndex)" 
                                    [showClear]="true">
                                </p-dropdown>
                                <small class="p-error" *ngIf="submitted && item.get('itemId')?.invalid">
                                    Please select an item
                                </small>
                            </div>

                            <!-- Variants for Products -->
                            <div class="space-y-2" *ngIf="item.get('itemType')?.value === 'Product'">
                                <label class="flex items-center text-sm font-semibold text-gray-700 dark:text-gray-300">
                                    <i class="pi pi-palette mr-2 text-green-600"></i>
                                    Product Variants
                                </label>
                                <div class="flex items-center gap-3">
                                    <p-button 
                                        icon="pi pi-tag"
                                        [label]="item.get('selectedVariants')?.value?.length > 0 ? 'Edit Variants (' + item.get('selectedVariants')?.value?.length + ')' : 'Add Variants'"
                                        [severity]="item.get('selectedVariants')?.value?.length > 0 ? 'success' : 'secondary'"
                                        [outlined]="true"
                                        styleClass="flex-1"
                                        (onClick)="openVariantDialog(rowIndex)"
                                        [disabled]="!item.get('itemId')?.value">
                                    </p-button>
                                </div>
                                
                                <!-- Selected Variants Display -->
                                <div *ngIf="item.get('selectedVariants')?.value?.length > 0"
                                    class="mt-3 p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800">
                                    <h6 class="text-sm font-semibold text-green-800 dark:text-green-200 mb-2 flex items-center">
                                        <i class="pi pi-check-circle mr-2"></i>Selected Variants
                                    </h6>
                                    <div class="flex flex-wrap gap-2">
                                        <span *ngFor="let variant of item.get('selectedVariants')?.value"
                                            class="inline-flex items-center gap-2 bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-200 px-3 py-2 rounded-lg text-sm font-medium">
                                            <span class="font-bold">{{ variant.variant }}:</span>
                                            <span>{{ variant.value?.en || variant.value }}</span>
                                            <img *ngIf="variant.image?.url" [src]="variant.image.url" alt="Variant"
                                                class="w-6 h-6 rounded object-cover variant-image cursor-pointer hover:scale-150 transition-transform"
                                                (click)="previewImage(variant.image.url, variant.variant + ' - ' + (variant.value?.en || variant.value))">
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Package Edit Button -->
                            <div class="space-y-2" *ngIf="item.get('itemType')?.value === 'Package' && item.get('itemId')?.value">
                                <label class="flex items-center text-sm font-semibold text-gray-700 dark:text-gray-300">
                                    <i class="pi pi-box mr-2 text-blue-600"></i>
                                    Package Configuration
                                </label>
                                <p-button 
                                    icon="pi pi-cog"
                                    label="Configure Package Variants"
                                    severity="info"
                                    [outlined]="true"
                                    styleClass="w-full"
                                    (onClick)="editPackageVariants(rowIndex)">
                                </p-button>
                            </div>
                        </div>

                        <!-- Right Column - Pricing -->
                        <div class="space-y-4">
                            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-lg p-4 border border-blue-200 dark:border-blue-800">
                                <h5 class="font-bold text-blue-900 dark:text-blue-200 mb-4 flex items-center">
                                    <i class="pi pi-calculator mr-2"></i>
                                    Pricing Details
                                </h5>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <!-- Price -->
                                    <div class="space-y-2">
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                            <i class="pi pi-dollar mr-1"></i>Price
                                        </label>
                                        <p-inputNumber 
                                            mode="currency" 
                                            currency="USD" 
                                            locale="en-US" 
                                            formControlName="price"
                                            (onInput)="calculateTotal()" 
                                            styleClass="w-full" 
                                            placeholder="0.00">
                                        </p-inputNumber>
                                    </div>

                                    <!-- Quantity -->
                                    <div class="space-y-2">
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                            <i class="pi pi-sort-numeric-up mr-1"></i>Quantity
                                        </label>
                                        <p-inputNumber 
                                            formControlName="quantity" 
                                            [min]="1" 
                                            [showButtons]="true"
                                            (onInput)="calculateTotal()"
                                            styleClass="w-full" 
                                            placeholder="1">
                                        </p-inputNumber>
                                    </div>

                                    <!-- Discount -->
                                    <div class="space-y-2">
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                            <i class="pi pi-percentage mr-1"></i>Discount
                                        </label>
                                        <p-inputNumber 
                                            mode="currency" 
                                            currency="USD" 
                                            locale="en-US" 
                                            formControlName="discountPrice"
                                            (onInput)="calculateTotal()" 
                                            styleClass="w-full" 
                                            placeholder="0.00">
                                        </p-inputNumber>
                                    </div>

                                    <!-- Total -->
                                    <div class="space-y-2">
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                            <i class="pi pi-money-bill mr-1"></i>Total
                                        </label>
                                        <p-inputNumber 
                                            mode="currency" 
                                            currency="USD" 
                                            locale="en-US" 
                                            formControlName="totalPrice"
                                            [readonly]="true" 
                                            styleClass="w-full"
                                            [inputStyleClass]="'bg-gray-100 dark:bg-gray-700 font-bold text-lg'">
                                        </p-inputNumber>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Package Contents Display -->
                    <div *ngIf="item.get('itemType')?.value === 'Package' && item.get('packageItems')?.value?.length > 0"
                        class="mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-700">
                        <h6 class="text-sm font-bold text-blue-800 dark:text-blue-200 mb-3 flex items-center">
                            <i class="pi pi-box mr-2"></i>
                            Package Contents ({{ item.get('packageItems')?.value?.length }} products)
                        </h6>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div *ngFor="let packageItem of item.get('packageItems')?.value; let i = index"
                                class="bg-white dark:bg-gray-800 rounded-lg p-3 border border-blue-200 dark:border-blue-700 hover:shadow-md transition-shadow">
                                <div class="flex items-start justify-between mb-2">
                                    <div class="flex-1">
                                        <p class="text-sm font-semibold text-gray-900 dark:text-white">
                                            {{ packageItem.productId.name | multiLanguage: 'en' }}
                                        </p>
                                        <span class="text-xs bg-blue-100 dark:bg-blue-800 text-blue-800 dark:text-blue-200 px-2 py-1 rounded mt-1 inline-block">
                                            Qty: {{ packageItem.quantity }}
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Package Product Variants -->
                                <div *ngIf="packageItem.selectedVariants && packageItem.selectedVariants.length > 0"
                                    class="mt-2 pt-2 border-t border-gray-200 dark:border-gray-600">
                                    <p class="text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Variants:</p>
                                    <div class="flex flex-wrap gap-1">
                                        <span *ngFor="let variant of packageItem.selectedVariants"
                                            class="text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-2 py-1 rounded flex items-center gap-1">
                                            <span class="font-medium">{{ variant.variant }}:</span>
                                            <span>{{ variant.value?.en || variant.value }}</span>
                                            <img *ngIf="variant.image" [src]="variant.image.filePath"
                                                alt="Variant" class="w-4 h-4 rounded object-cover variant-image cursor-pointer"
                                                (click)="previewImage(variant.image.filePath, variant.variant + ' - ' + (variant.value?.en || variant.value))">
                                        </span>
                                    </div>
                                </div>
                                <div *ngIf="!packageItem.selectedVariants || packageItem.selectedVariants.length === 0"
                                    class="mt-2 pt-2 border-t border-gray-200 dark:border-gray-600">
                                    <p class="text-xs text-gray-500 italic">No variants selected</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </ng-container>

            <!-- Empty State -->
            <div *ngIf="items.length === 0" 
                class="bg-white dark:bg-gray-800 rounded-xl border-2 border-dashed border-gray-300 dark:border-gray-600 p-12 text-center">
                <div class="w-20 h-20 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="pi pi-shopping-bag text-4xl text-gray-400"></i>
                </div>
                <h4 class="text-lg font-bold text-gray-900 dark:text-white mb-2">No items added yet</h4>
                <p class="text-gray-500 dark:text-gray-400 mb-4">Start by adding products or packages to this order</p>
                <p-button 
                    icon="pi pi-plus" 
                    label="Add First Item" 
                    severity="success" 
                    (click)="addItem()"
                    styleClass="p-button-raised">
                </p-button>
            </div>
        </div>
    </div>

    <!-- Order Summary Section -->
    <div
        class="bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-900 rounded-xl p-6 shadow-lg border border-gray-200 dark:border-gray-700">
        <div class="flex items-center gap-3 mb-6">
            <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center">
                <i class="pi pi-calculator text-blue-600 dark:text-blue-400"></i>
            </div>
            <div>
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">Order Summary</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">Final pricing and totals</p>
            </div>
        </div>

        <div class="space-y-4">
            <!-- Subtotal -->
            <div
                class="flex justify-between items-center p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition-shadow duration-200">
                <div class="flex items-center">
                    <i class="pi pi-shopping-cart mr-3 text-gray-600 dark:text-gray-400"></i>
                    <span class="text-lg font-semibold text-gray-700 dark:text-gray-300">Subtotal</span>
                </div>
                <span class="text-xl font-bold text-gray-900 dark:text-white">
                    {{ orderForm.get('subtotal')?.value | currency:'USD':'symbol':'1.2-2' }}
                </span>
            </div>

            <!-- Tax -->
            <div
                class="flex justify-between items-center p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition-shadow duration-200">
                <div class="flex items-center">
                    <i class="pi pi-percentage mr-3 text-gray-600 dark:text-gray-400"></i>
                    <span class="text-lg font-semibold text-gray-700 dark:text-gray-300">Tax</span>
                </div>
                <span class="text-xl font-bold text-gray-900 dark:text-white">
                    {{ orderForm.get('tax')?.value | currency:'USD':'symbol':'1.2-2' }}
                </span>
            </div>

            <!-- Shipping -->
            <div
                class="flex justify-between items-center p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition-shadow duration-200">
                <div class="flex items-center">
                    <i class="pi pi-truck mr-3 text-gray-600 dark:text-gray-400"></i>
                    <span class="text-lg font-semibold text-gray-700 dark:text-gray-300">Shipping</span>
                </div>
                <span class="text-xl font-bold text-gray-900 dark:text-white">
                    {{ orderForm.get('shippingCost')?.value | currency:'USD':'symbol':'1.2-2' }}
                </span>
            </div>

            <!-- Total -->
            <div
                class="flex justify-between items-center p-6 bg-gradient-to-r from-blue-500 to-blue-600 dark:from-blue-600 dark:to-blue-700 rounded-lg shadow-lg border-2 border-blue-400 dark:border-blue-500">
                <div class="flex items-center">
                    <i class="pi pi-dollar mr-3 text-white"></i>
                    <span class="text-2xl font-bold text-white">Total</span>
                </div>
                <span class="text-3xl font-bold text-white">
                    {{ orderForm.get('total')?.value | currency:'USD':'symbol':'1.2-2' }}
                </span>
            </div>
        </div>
    </div>
    

    <!-- Cash Payment Section (Only in Edit Mode) -->
    @if (isEditOrder) {
    <div
        class="bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20 rounded-lg p-6 mt-6">
        <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 bg-yellow-100 dark:bg-yellow-900 rounded-full flex items-center justify-center">
                <i class="pi pi-money-bill text-yellow-600 dark:text-yellow-400"></i>
            </div>
            <div>
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">Cash Payment Details</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">Track cash payments and change</p>
            </div>
        </div>
        <ng-container [formGroup]="cashPayment">
            <div class="space-y-4">
                <!-- Cash Payment Fields -->

                <!-- Cash Payment Input -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            <i class="pi pi-money-bill mr-2"></i>Amount Paid
                        </label>
                        <p-inputNumber mode="currency" currency="USD" locale="en-US" formControlName="amountPaid"
                            (onInput)="calculateChangeDue()" class="w-full" placeholder="0.00">
                        </p-inputNumber>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            <i class="pi pi-calculator mr-2"></i>Change Due
                        </label>
                        <p-inputNumber mode="currency" currency="USD" locale="en-US" formControlName="changeDue"
                            [readonly]="true" class="w-full bg-gray-50 dark:bg-gray-700">
                        </p-inputNumber>
                    </div>
                </div>

                <!-- Payment Image Upload -->
                <div class="space-y-2" *ngIf="orderForm.get('paymentMethod')?.value === 'vodafone_cash'">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                        <i class="pi pi-image mr-2"></i>Payment Screenshot
                    </label>
                    <div class="flex items-center gap-4">
                        <input type="file" accept="image/*" (change)="onPaymentImageChange($event)"
                            class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        <div *ngIf="getPaymentImageUrl()" class="flex items-center gap-2">
                            <div class="image-preview-container">
                                <img [src]="getPaymentImageUrl()" alt="Payment Preview"
                                    class="w-16 h-16 object-cover rounded border payment-image-preview"
                                    (click)="previewImage(getPaymentImageUrl()!, 'Payment Screenshot')">
                            </div>
                            <p-button icon="pi pi-times" severity="danger" [rounded]="true" [outlined]="true"
                                size="small" (click)="removePaymentImage()">
                            </p-button>
                        </div>
                    </div>
                </div>
            </div>
        </ng-container>
    </div>
    }


    <!-- Notes Section -->
    <div class="bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-900 rounded-lg p-6 mt-6">
        <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center">
                <i class="pi pi-file-edit text-gray-600 dark:text-gray-400"></i>
            </div>
            <div>
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">Order Notes</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">Additional information and comments</p>
            </div>
        </div>
        <div class="space-y-2">
            <label for="notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                <i class="pi pi-comment mr-2"></i>Notes
            </label>
            <textarea id="notes" pTextarea formControlName="notes" rows="4" class="w-full"
                placeholder="Enter any additional notes or special instructions...">
                    </textarea>
        </div>
    </div>
</form>
</div>
}


    <ng-template pTemplate="footer">
        <div
            class="flex flex-col sm:flex-row justify-end gap-3 p-6 bg-gray-50 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">
            <p-button label="Cancel" icon="pi pi-times" (click)="hideDialog()" severity="secondary" [outlined]="true"
                size="large">
            </p-button>
            <p-button [label]="orderForm.get('_id')?.value ? 'Update Order' : 'Create Order'" icon="pi pi-check"
                (click)="saveOrder()" [loading]="loading()" severity="success" size="large">
            </p-button>
        </div>
    </ng-template>
</p-dialog>

<!-- Toast for messages -->
<p-toast></p-toast>

<!-- Confirmation dialog for delete -->
<p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>

<!-- Variant Edit Dialog -->
<p-dialog [(visible)]="variantDialog" [style]="{width: '60vw'}" header="Edit Product Variants" [modal]="true"
    [closable]="true" [resizable]="true" [draggable]="true" [dismissableMask]="true"
    [contentStyle]="{'max-height': '80vh'}">

    @if(variantDialog && selectedItemIndex !== null) {
    <div class="space-y-4">
        <!-- Product Info -->
        <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
            <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">
                <i class="pi pi-box mr-2"></i>Product: {{ getSelectedProductName() }}
            </h4>
            <p class="text-sm text-blue-600 dark:text-blue-300">
                Current variants: {{ getCurrentVariantsCount() }}
            </p>
        </div>

        <!-- Available Variants -->
        <div class="space-y-3">
            <h5 class="font-semibold text-gray-800 dark:text-gray-200">
                <i class="pi pi-tag mr-2"></i>Available Variants
            </h5>

            <div *ngIf="availableVariants.length === 0" class="text-center py-8 text-gray-500">
                <i class="pi pi-info-circle text-2xl mb-2"></i>
                <p>No variants available for this product</p>
            </div>

            <div *ngFor="let variant of availableVariants"
                class="border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                    <h6 class="font-medium text-gray-800 dark:text-gray-200 capitalize">
                        {{ variant.variant }}
                    </h6>
                    <p-checkbox [ngModel]="isVariantSelected(variant)" (onChange)="toggleVariant(variant, $event)"
                        [binary]="true">
                    </p-checkbox>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                    <div *ngFor="let option of variant.options"
                        class="flex items-center space-x-2 p-2 border rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700"
                        [class.bg-blue-100]="isVariantOptionSelected(variant.variant, option)"
                        [class.dark:bg-blue-900]="isVariantOptionSelected(variant.variant, option)"
                        (click)="selectVariantOption(variant.variant, option)">
                        <img *ngIf="option.image?.url" [src]="option.image.url" alt="Variant"
                            class="w-8 h-8 rounded object-cover">
                        <span class="text-sm">{{ option.value.en || option.value }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Selected Variants Summary -->
        <div *ngIf="getSelectedVariantsSummary().length > 0" class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
            <h5 class="font-semibold text-green-800 dark:text-green-200 mb-3">
                <i class="pi pi-check-circle mr-2"></i>Selected Variants
            </h5>
            <div class="flex flex-wrap gap-2">
                <span *ngFor="let variant of getSelectedVariantsSummary()"
                    class="bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-200 px-3 py-1 rounded-full text-sm flex items-center gap-2">
                    <span class="font-medium">{{ variant.variant }}:</span>
                    <span>{{ variant.value.en || variant.value }}</span>
                    <img *ngIf="variant.image?.url" [src]="variant.image.url" alt="Variant"
                        class="w-4 h-4 rounded object-cover variant-image"
                        (click)="previewImage(variant.image.url, variant.variant + ' - ' + (variant.value.en || variant.value))">
                    <button type="button" class="text-green-600 hover:text-green-800 ml-1"
                        (click)="removeVariant(variant)">
                        <i class="pi pi-times text-xs"></i>
                    </button>
                </span>
            </div>
        </div>
    </div>
    }

    <ng-template pTemplate="footer">
        <div class="flex justify-end gap-2">
            <p-button label="Cancel" severity="secondary" icon="pi pi-times" (click)="closeVariantDialog()">
            </p-button>
            <p-button label="Save Variants" severity="success" icon="pi pi-check" (click)="saveVariants()">
            </p-button>
        </div>
    </ng-template>
</p-dialog>


<!-- Package Details Dialog -->
<p-dialog [(visible)]="packageDetailsDialog" [style]="{width: '70vw'}" header="Package Details - Select Variants"
    [modal]="true" [closable]="true" [resizable]="true" [draggable]="true" [dismissableMask]="true"
    [contentStyle]="{'max-height': '80vh'}">

    @if(packageDetailsDialog && selectedPackageForDetails) {
    <div class="space-y-4">
        <!-- Package Info -->
        <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
            <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">
                <i class="pi pi-box mr-2"></i>Package: {{ selectedPackageForDetails.name?.en }}
            </h4>
            <p class="text-sm text-blue-600 dark:text-blue-300">
                Select variants for each product in this package
            </p>
        </div>

        <!-- Package Products -->
        <div class="space-y-3">
            <h5 class="font-semibold text-gray-800 dark:text-gray-200">
                <i class="pi pi-list mr-2"></i>Package Products
            </h5>

            <div *ngFor="let packageItem of tempPackageItems; let i = index"
                class="border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex-1">
                        <h6 class="font-medium text-gray-800 dark:text-gray-200">
                            {{ getProductName(packageItem.productId) }}
                        </h6>
                        <p class="text-sm text-gray-600 dark:text-gray-400">
                            Quantity: {{ packageItem.quantity }}
                        </p>
                    </div>
                    <div class="flex flex-col items-center gap-2 max-w-[200px]">
                        <p-inputNumber [(ngModel)]="packageItem.quantity" [min]="1" [max]="10" size="small"
                            >
                        </p-inputNumber>
                        <p-button [icon]="expandedProductIndex === i ? 'pi pi-chevron-up' : 'pi pi-chevron-down'"
                            [label]="expandedProductIndex === i ? 'Hide Variants' : 'Show Variants'"
                            styleClass="p-button-sm p-button-outlined" (onClick)="toggleProductVariants(i)">
                        </p-button>
                    </div>
                </div>

                <!-- Variants Selection (Expandable) -->
                <div *ngIf="expandedProductIndex === i" class="mt-4 border-t border-gray-200 dark:border-gray-600 pt-4">
                    <h6 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                        <i class="pi pi-tag mr-2"></i>Select Variants
                    </h6>

                    <div *ngFor="let variant of productVariantsCache[packageItem.productId] || []" class="mb-4">
                        <div class="text-xs font-medium text-gray-600 dark:text-gray-400 capitalize mb-2">
                            {{ variant.variant }}
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                            <button type="button" *ngFor="let option of variant.options"
                                (click)="selectProductVariantOption(i, variant.variant, option)"
                                class="flex items-center space-x-2 p-2 border rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                                [class.bg-blue-100]="isProductVariantSelected(i, variant.variant, option)"
                                [class.dark:bg-blue-900]="isProductVariantSelected(i, variant.variant, option)"
                                [class.border-blue-300]="isProductVariantSelected(i, variant.variant, option)">
                                <img *ngIf="option.image?.url" [src]="option.image.url" alt="Variant"
                                    class="w-6 h-6 rounded object-cover">
                                <span class="text-xs">{{ option.value.en || option.value }}</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Selected Variants Display -->
                <div *ngIf="getSelectedVariantsForProduct(i).length > 0"
                    class="mt-3 p-3 bg-green-50 dark:bg-green-900/20 rounded">
                    <h6 class="text-sm font-medium text-green-800 dark:text-green-200 mb-2">
                        Selected Variants:
                    </h6>
                    <div class="flex flex-wrap gap-2">
                        <span *ngFor="let variant of getSelectedVariantsForProduct(i)"
                            class="bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-200 px-2 py-1 rounded text-xs flex items-center gap-1">
                            <span class="font-medium">{{ variant.variant }}:</span>
                            <span>{{ variant.value?.en || variant.value }}</span>
                            <img *ngIf="variant.image?.filePath" [src]="variant.image.filePath" alt="Variant"
                                class="w-3 h-3 rounded object-cover variant-image"
                                (click)="previewImage(variant.image.filePath, variant.variant + ' - ' + (variant.value?.en || variant.value))">
                            <button type="button" class="text-green-600 hover:text-green-800 ml-1"
                                (click)="removeProductVariant(i, variant)">
                                <i class="pi pi-times text-xs"></i>
                            </button>
                        </span>
                    </div>
                </div>

                <div *ngIf="getSelectedVariantsForProduct(i).length === 0 && expandedProductIndex !== i"
                    class="mt-3 p-3 bg-gray-50 dark:bg-gray-800 rounded">
                    <p class="text-sm text-gray-500 dark:text-gray-400 italic">
                        No variants selected
                    </p>
                </div>
            </div>
        </div>
    </div>
    }

    <ng-template pTemplate="footer">
        <div class="flex justify-end gap-2">
            <p-button label="Cancel" severity="secondary" icon="pi pi-times" (click)="closePackageDetailsDialog()">
            </p-button>
            <p-button label="Save Package Details" severity="success" icon="pi pi-check" (click)="savePackageDetails()">
            </p-button>
        </div>
    </ng-template>
</p-dialog>


<!-- Image Preview Dialog -->
<p-dialog [(visible)]="imagePreviewDialog" [header]="previewImageTitle" [modal]="true" [closable]="true" 
    [resizable]="true" [draggable]="true" [dismissableMask]="true" [style]="{width: '90vw', maxWidth: '800px'}"
    [contentStyle]="{'max-height': '90vh', 'overflow': 'auto'}">
    
    @if (imagePreviewDialog && previewImageUrl) {
    <div class="text-center">
        <img [src]="previewImageUrl" [alt]="previewImageTitle" 
            class="max-w-full max-h-[70vh] object-contain rounded-lg shadow-lg">
        
        <div class="mt-4 flex justify-center gap-2">
            <p-button label="Download" icon="pi pi-download" severity="secondary" 
                (click)="downloadImage()" [outlined]="true">
            </p-button>
            <p-button label="Close" icon="pi pi-times" severity="secondary" 
                (click)="closeImagePreview()" [outlined]="true">
            </p-button>
        </div>
    </div>
    }
</p-dialog>

<!-- Tracking timeline removed -->