<!-- Header with title and actions -->
<p-toast></p-toast>
<p-toolbar styleClass="mb-4 gap-2">
    <ng-template pTemplate="left">
        <div class="my-2">
            <p-button severity="success" label="New Order" icon="pi pi-plus" class="mr-2" (click)="openNew()"
                [style]="{'margin-right': '.5em'}">
            </p-button>
        </div>
    </ng-template>
</p-toolbar>

<!-- Order Table -->
<p-table #dt [value]="orders()" [loading]="loading()"
    [globalFilterFields]="['orderNumber', 'customer.name', 'status', 'paymentStatus']"
    [tableStyle]="{'min-width': '75rem'}" [selection]="selectedOrders" [(selection)]="selectedOrders" dataKey="_id">
    <ng-template pTemplate="caption">
        <div class="flex flex-column md:flex-row md:justify-between md:align-items-center">
            <h5 class="m-0">Manage Orders</h5>
            <p-iconField iconPosition="left" class="ml-auto">
                <p-inputIcon>
                    <i class="pi pi-search"></i>
                </p-inputIcon>
                <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Search..."
                    class="w-full sm:w-auto" />
            </p-iconField>
        </div>
    </ng-template>
    <ng-template pTemplate="header">
        <tr>
            <!-- <th style="width: 4rem">
                <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
            </th> -->
            <th pSortableColumn="orderNumber">Order # <p-sortIcon field="orderNumber"></p-sortIcon></th>
            <!-- <th pSortableColumn="user.name">User <p-sortIcon field="user.name"></p-sortIcon></th> -->
            <th pSortableColumn="total">Total <p-sortIcon field="total"></p-sortIcon></th>
            <th pSortableColumn="status">Status <p-sortIcon field="status"></p-sortIcon></th>
            <th pSortableColumn="paymentStatus">Payment <p-sortIcon field="paymentStatus"></p-sortIcon></th>
            <th pSortableColumn="createdAt">Date <p-sortIcon field="createdAt"></p-sortIcon></th>
            <th pSortableColumn="createdAt">Time <p-sortIcon field="createdAt"></p-sortIcon></th>

            <th style="width: 12rem"></th>
        </tr>
        <!-- <tr>
            <th></th>
            <th>
                <p-columnFilter type="text" field="orderNumber"></p-columnFilter>
                <input pInputText type="text" (input)="filterOrders($event, 'orderNumber')" class="w-full">
            </th>
            <th>
                <p-columnFilter type="text" field="customer.name"></p-columnFilter>
                <input pInputText type="text" (input)="filterOrders($event, 'customer.name')" class="w-full">
            </th>
            <th colspan="4"></th>
            <th>
                <button pButton pRipple type="button" icon="pi pi-filter-slash" class="p-button-outlined"
                    (click)="dt.clear()"></button>
            </th>
        </tr> -->
    </ng-template>

    <ng-template pTemplate="body" let-order>
        <tr>
            <!-- <td>
                <p-tableCheckbox [value]="order"></p-tableCheckbox>
            </td> -->
            <td>{{ order.orderNumber }}</td>
            <!-- <td>{{ order.user?.name }}</td> -->
            <td>{{ order.total | currency:'USD':'symbol':'1.2-2' }}</td>
            <td>
                <p-tag [value]="order.orderStatus | titlecase" [severity]="getSeverity(order.orderStatus)"></p-tag>
            </td>
            <td>
                <p-tag [value]="order.paymentStatus | titlecase"
                    [severity]="getPaymentSeverity(order.paymentStatus)"></p-tag>
            </td>
            <td>{{ order.createdAt | date:'shortDate' }}</td>
            <td>{{ order.createdAt | date:'shortTime' }}</td>
            <td>
                <div class="flex">
                    <p-button icon="pi pi-pencil" class="mr-2" [rounded]="true" [outlined]="true" severity="success"
                        (click)="editOrder(order)"></p-button>
                    <p-button icon="pi pi-trash" severity="warn" [rounded]="true" [outlined]="true"
                        (click)="deleteOrder(order)"></p-button>
                </div>
            </td>
        </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
        <tr>
            <td colspan="9" class="text-center py-6">
                <div class="flex flex-column gap-2 items-center justify-center">
                    <i class="pi pi-inbox text-5xl text-400"></i>
                    <span class="text-xl text-600">No orders found.</span>
                </div>
            </td>
        </tr>
    </ng-template>
    <!-- pagination -->
    <ng-template pTemplate="footer">
        <tr>
            <td colspan="9" class="text-center py-6">
                <p-paginator [rows]="pagination().limit" [totalRecords]="pagination().total"
                    [rowsPerPageOptions]="[5, 10, 25, 50]" (onPageChange)="onPageChange($event)"></p-paginator>
            </td>
        </tr>
    </ng-template>
</p-table>

<!-- Order Dialog -->
<p-dialog [(visible)]="orderDialog" [style]="{width: '80vw'}"
    header="{{orderForm.get('_id')?.value ? 'Edit Order' : 'New Order'}}" [modal]="true" [closable]="false"
    [resizable]="true" [draggable]="true" [dismissableMask]="true" [contentStyle]="{'max-height': '90vh'}"
    [styleClass]="'order-dialog'">
    @if(orderDialog){
    <form [formGroup]="orderForm">
        <h4 class="mb-4">Order Information</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- <div class="field">
                <label for="orderNumber">Order #</label>
                <input id="orderNumber" pInputText formControlName="orderNumber"
                    [class.p-invalid]="submitted && orderForm.get('orderNumber')?.invalid">
                <small class="p-error" *ngIf="submitted && orderForm.get('orderNumber')?.invalid">Order number is
                    required</small>
            </div> -->

            <div class="field">
                <label for="orderStatus">Order Status</label>
                <p-dropdown id="orderStatus" [options]="statusOptions" formControlName="orderStatus" optionLabel="label"
                    optionValue="value" [style]="{'width':'100%'}">
                </p-dropdown>
            </div>

            <div class="field">
                <label for="paymentStatus">Payment Status</label>
                <p-dropdown id="paymentStatus" [options]="paymentStatusOptions" formControlName="paymentStatus"
                    optionLabel="label" optionValue="value" [style]="{'width':'100%'}">
                </p-dropdown>
            </div>

            <div class="field">
                <label for="paymentMethod">Payment Method</label>
                <p-dropdown id="paymentMethod" [options]="paymentMethodOptions" formControlName="paymentMethod"
                    optionLabel="label" optionValue="value" [style]="{'width':'100%'}">
                </p-dropdown>
            </div>
        </div>

        <div class="w-full">
            <h4 class="mb-4">Shipping Address</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" formGroupName="shippingAddress">
                <div class="field">
                    <label for="fullName">Full Name</label>
                    <input id="fullName" pInputText formControlName="fullName"
                        [class.p-invalid]="submitted && orderForm.get('shippingAddress.fullName')?.invalid">
                    <small class="p-error" *ngIf="submitted && orderForm.get('shippingAddress.fullName')?.invalid">Full
                        name is
                        required</small>
                </div>
                <div class="field">
                    <label for="phone">Phone</label>
                    <input id="phone" pInputText formControlName="phone"
                        [class.p-invalid]="submitted && orderForm.get('shippingAddress.phone')?.invalid">
                    <small class="p-error" *ngIf="submitted && orderForm.get('shippingAddress.phone')?.invalid">Phone is
                        required</small>
                </div>
                <div class="field">
                    <label for="address">address</label>
                    <input id="address" pInputText formControlName="address"
                        [class.p-invalid]="submitted && orderForm.get('shippingAddress.address')?.invalid">
                    <small class="p-error"
                        *ngIf="submitted && orderForm.get('shippingAddress.address')?.invalid">address
                        is
                        required</small>
                </div>
                <div class="field">
                    <label for="city">City</label>
                    <input id="city" pInputText formControlName="city"
                        [class.p-invalid]="submitted && orderForm.get('shippingAddress.city')?.invalid">
                    <small class="p-error" *ngIf="submitted && orderForm.get('shippingAddress.city')?.invalid">City
                        is required</small>
                </div>
                <div class="field">
                    <label for="state">State</label>
                    <p-dropdown id="state" [options]="stateOptions()" formControlName="state" optionLabel="name.en"
                        optionValue="_id" [style]="{'width':'100%'}">
                    </p-dropdown>
                    <small class="p-error"
                        *ngIf="submitted && orderForm.get('shippingAddress.state')?.invalid">State is
                        required</small>
                </div>
                <!-- <div class="field">
                    <label for="zipCode">ZIP/Postal Code</label>
                    <input id="zipCode" pInputText formControlName="zipCode"
                        [class.p-invalid]="submitted && orderForm.get('shippingAddress.zipCode')?.invalid">
                    <small class="p-error" *ngIf="submitted && orderForm.get('shippingAddress.zipCode')?.invalid">ZIP
                        code is
                        required</small>
                </div> -->
                <div class="field col-12">
                    <label for="country">Country</label>
                    <p-dropdown id="country" [options]="countryOptions()"
                     formControlName="country" optionLabel="name.en"
                        optionValue="_id" [style]="{'width':'100%'}">
                        (onChange)="loadStates()"
                    </p-dropdown>
                    <small class="p-error"
                        *ngIf="submitted && orderForm.get('shippingAddress.country')?.invalid">Country is
                        required</small>
                </div>

            </div>
        </div>

        <h4 class="mb-4">Order Items</h4>
        <div class="flex justify-content-between align-items-center mb-3">
            <button type="button" pButton pRipple icon="pi pi-plus" label="Add Item" class="p-button-sm"
                (click)="addItem()"></button>
        </div>

        <p-table [value]="items.controls" [scrollable]="true" scrollHeight="600px" columnResizeMode="fit"
            [rowHover]="true" [resizableColumns]="true">
            <ng-template pTemplate="header">
                <tr>
                    <th>Type</th>
                    <th>Item</th>
                    <!-- <th>Color</th> -->
                    <!-- <th>Size</th> -->
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Discount</th>
                    <th>Total</th>
                    <th></th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item let-rowIndex="rowIndex">
                <tr [formGroup]="item">
                    <td class="w-28 p-0">
                        <p-dropdown formControlName="itemType" [options]="[
                                {label: 'Product', value: 'product'},
                                {label: 'Package', value: 'package'}
                            ]" appendTo="body" optionLabel="label" optionValue="value" placeholder="Select Type"
                            styleClass="w-full" [class.p-invalid]="submitted && item.get('itemType')?.invalid"
                            (onChange)="onItemTypeChange($event,rowIndex)">
                        </p-dropdown>
                    </td>
                    <td class="w-28 p-0">
                        <p-dropdown formControlName="itemId"
                            [options]="item.get('itemType')?.value === 'package' ? packages() : products()"
                            appendTo="body" optionLabel="name.en" optionValue="_id" placeholder="Select Item"
                            styleClass="w-full" filter="true" filterBy="name"
                            [class.p-invalid]="submitted && item.get('itemId')?.invalid"
                            (onChange)="onItemChange($event,rowIndex)">
                        </p-dropdown>
                    </td>
                    <!-- <td class="w-28 p-0">
                        <p-dropdown formControlName="color" [options]="item.get('listColors')?.value" appendTo="body"
                            placeholder="Select Color" styleClass="w-full"
                            [class.p-invalid]="submitted && item.get('color')?.invalid"
                            [disabled]="item.get('itemType')?.value === 'package'"
                            (onChange)="onColorChange($event,rowIndex)">
                        </p-dropdown>
                    </td>
                    <td class="w-28 p-0">
                        <p-dropdown formControlName="size" 
                            [options]="item.get('listSizes')?.value" 
                            appendTo="body"
                            placeholder="Select Size" 
                            styleClass="w-full"
                            [class.p-invalid]="submitted && item.get('size')?.invalid"
                            [disabled]="item.get('itemType')?.value === 'package'"
                            (onChange)="onSizeChange($event,rowIndex)">
                        </p-dropdown>
                    </td> -->
                    <td class="w-28 p-0">
                        <p-inputNumber mode="currency" currency="USD" locale="en-US" formControlName="price"
                            (onInput)="calculateTotal()" class="w-full">
                        </p-inputNumber>
                    </td>
                    <td class="w-28 p-0">
                        <p-inputNumber formControlName="quantity" [min]="1" (onInput)="calculateTotal()" class="w-full">
                        </p-inputNumber>
                    </td>
                    <td class="w-28 p-0">
                        <p-inputNumber mode="currency" currency="USD" locale="en-US" formControlName="discountPrice"
                            (onInput)="calculateTotal()" class="w-full">
                        </p-inputNumber>
                    </td>
                    <td class="w-28 p-0">
                        <p-inputNumber mode="currency" currency="USD" locale="en-US" formControlName="totalPrice"
                            [readonly]="true" class="w-full">
                        </p-inputNumber>
                    </td>
                    <td style="width: 50px" class="text-center">
                        <button type="button" pButton pRipple icon="pi pi-trash"
                            class="p-button-rounded p-button-text p-button-danger p-button-sm"
                            (click)="removeItem(rowIndex)">
                        </button>
                    </td>
                </tr>

                <!-- Package Items Details Row -->
                <tr *ngIf="item.get('itemType')?.value === 'package' && item.get('packageItems')?.value?.length > 0"
                    class="bg-blue-50 dark:bg-blue-900/20">
                    <td colspan="9" class="p-3">
                        <div class="ml-4">
                            <h6 class="text-sm font-semibold text-blue-800 dark:text-blue-200 mb-2">
                                <i class="pi pi-box mr-2"></i>Package Contents:
                            </h6>
                            <div class="flex flex-wrap w-full gap-3">
                                <div *ngFor="let packageItem of item.get('packageItems')?.value"
                                    class="flex flex-wrap gap-3 bg-white dark:bg-gray-800 rounded-lg p-3 border border-blue-200 dark:border-blue-700">
                                    <div class="flex items-center justify-between mb-2 gap-2 w-full">
                                        <span class="text-sm font-medium text-gray-900 dark:text-white">
                                            Product Name: {{ packageItem.productId.name }}
                                        </span>
                                        <span
                                            class="text-xs bg-blue-100 dark:bg-blue-800 text-blue-800 dark:text-blue-200 px-2 py-1 rounded">
                                            Qty: {{ packageItem.quantity }}
                                        </span>
                                    </div>

                                    <!-- Selected Variants -->
                                    <div *ngIf="packageItem.selectedVariants && packageItem.selectedVariants.length > 0"
                                        class="mt-2 w-full">
                                        <h6 class="text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">
                                            Selected Variants:
                                        </h6>
                                        <div class="flex flex-wrap gap-1">
                                            <span *ngFor="let variant of packageItem.selectedVariants"
                                                class="text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-2 py-1 rounded">
                                                {{ variant.variant }}: {{ variant.value.en }}
                                                <img [src]="getVariantImage(variant.value , packageItem.productId) || ''"
                                                    alt="Variant Image" class="w-10 h-auto">
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>

                <!-- Selected Variants for Products -->
                <tr *ngIf="item.get('itemType')?.value === 'product' && item.get('selectedVariants')?.value?.length > 0"
                    class="bg-green-50 dark:bg-green-900/20">
                    <td colspan="9" class="p-3">
                        <div class="ml-4">
                            <h6 class="text-sm font-semibold text-green-800 dark:text-green-200 mb-2">
                                <i class="pi pi-tag mr-2"></i>Selected Variants:
                            </h6>
                            <div class="flex flex-wrap gap-2">
                                <span *ngFor="let variant of item.get('selectedVariants')?.value"
                                    class="text-sm bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-200 px-3 py-1 rounded">
                                    {{ variant.variant }}: {{ variant.value.en }}
                                </span>
                            </div>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>

        <!-- Enhanced Order Summary Table -->
        <div class="bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-900 rounded-xl p-6 shadow-lg border border-gray-200 dark:border-gray-700">
            <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
                <i class="pi pi-calculator mr-3 text-blue-600 dark:text-blue-400"></i>
                Order Summary
            </h3>
            
            <div class="space-y-4">
                <!-- Subtotal -->
                <div class="flex justify-between items-center p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition-shadow duration-200">
                    <div class="flex items-center">
                        <i class="pi pi-shopping-cart mr-3 text-gray-600 dark:text-gray-400"></i>
                        <span class="text-lg font-semibold text-gray-700 dark:text-gray-300">Subtotal</span>
                    </div>
                    <span class="text-xl font-bold text-gray-900 dark:text-white">
                        {{ orderForm.get('subtotal')?.value | currency:'USD':'symbol':'1.2-2' }}
                    </span>
                </div>

                <!-- Tax -->
                <div class="flex justify-between items-center p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition-shadow duration-200">
                    <div class="flex items-center">
                        <i class="pi pi-percentage mr-3 text-gray-600 dark:text-gray-400"></i>
                        <span class="text-lg font-semibold text-gray-700 dark:text-gray-300">Tax</span>
                    </div>
                    <span class="text-xl font-bold text-gray-900 dark:text-white">
                        {{ orderForm.get('tax')?.value | currency:'USD':'symbol':'1.2-2' }}
                    </span>
                </div>

                <!-- Shipping -->
                <div class="flex justify-between items-center p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition-shadow duration-200">
                    <div class="flex items-center">
                        <i class="pi pi-truck mr-3 text-gray-600 dark:text-gray-400"></i>
                        <span class="text-lg font-semibold text-gray-700 dark:text-gray-300">Shipping</span>
                    </div>
                    <span class="text-xl font-bold text-gray-900 dark:text-white">
                        {{ orderForm.get('shippingCost')?.value | currency:'USD':'symbol':'1.2-2' }}
                    </span>
                </div>

                <!-- Total -->
                <div class="flex justify-between items-center p-6 bg-gradient-to-r from-blue-500 to-blue-600 dark:from-blue-600 dark:to-blue-700 rounded-lg shadow-lg border-2 border-blue-400 dark:border-blue-500">
                    <div class="flex items-center">
                        <i class="pi pi-dollar mr-3 text-white"></i>
                        <span class="text-2xl font-bold text-white">Total</span>
                    </div>
                    <span class="text-3xl font-bold text-white">
                        {{ orderForm.get('total')?.value | currency:'USD':'symbol':'1.2-2' }}
                    </span>
                </div>

                <!-- Cash Payment Section (Only in Edit Mode) -->
                @if (isEditOrder) {
                <ng-container [formGroup]="cashPayment">
                    <div class="mt-6 pt-6 border-t-2 border-gray-300 dark:border-gray-600">
                        <h4 class="text-xl font-bold text-gray-800 dark:text-white mb-4 flex items-center">
                            <i class="pi pi-credit-card mr-3 text-green-600 dark:text-green-400"></i>
                            Cash Payment
                        </h4>
                        
                        <!-- Cash Payment Input -->
                        <div class="flex justify-between items-center p-4 bg-gradient-to-r from-green-50 to-green-100 dark:from-green-900/20 dark:to-green-800/20 rounded-lg border-2 border-green-200 dark:border-green-700 shadow-sm hover:shadow-md transition-shadow duration-200">
                            <div class="flex items-center">
                                <i class="pi pi-money-bill mr-3 text-green-600 dark:text-green-400"></i>
                                <span class="text-lg font-semibold text-green-800 dark:text-green-300">Amount Paid</span>
                            </div>
                            <div class="w-48">
                                <p-inputNumber 
                                    mode="currency" 
                                    currency="USD" 
                                    locale="en-US" 
                                    formControlName="amountPaid"
                                    (onInput)="calculateChangeDue()" 
                                    class="w-full"
                                    styleClass="w-full"
                                    inputStyleClass="text-right font-semibold text-lg">
                                </p-inputNumber>
                            </div>
                        </div>

                        <!-- Change Due Display -->
                        <div class="flex justify-between items-center p-4 bg-gradient-to-r from-yellow-50 to-yellow-100 dark:from-yellow-900/20 dark:to-yellow-800/20 rounded-lg border-2 border-yellow-200 dark:border-yellow-700 shadow-sm hover:shadow-md transition-shadow duration-200 mt-3">
                            <div class="flex items-center">
                                <i class="pi pi-refresh mr-3 text-yellow-600 dark:text-yellow-400"></i>
                                <span class="text-lg font-semibold text-yellow-800 dark:text-yellow-300">Change Due</span>
                            </div>
                            <div class="w-48">
                                <p-inputNumber 
                                    mode="currency" 
                                    currency="USD" 
                                    locale="en-US" 
                                    formControlName="changeDue"
                                    [readonly]="true" 
                                    class="w-full"
                                    styleClass="w-full"
                                    inputStyleClass="text-right font-bold text-lg"
                                    [class.text-green-600]="cashPayment.get('changeDue')?.value >= 0"
                                    [class.text-red-600]="cashPayment.get('changeDue')?.value < 0">
                                </p-inputNumber>
                            </div>
                        </div>

                        <!-- Payment Status Indicator -->
                        <div class="mt-4 p-3 rounded-lg" 
                             [class.bg-green-100]="cashPayment.get('changeDue')?.value >= 0"
                             [class.bg-red-100]="cashPayment.get('changeDue')?.value < 0"
                             [class.dark:bg-green-900\30]="cashPayment.get('changeDue')?.value >= 0"
                             [class.dark:bg-red-900\30]="cashPayment.get('changeDue')?.value < 0">
                            <div class="flex items-center justify-center">
                                <i class="pi mr-2" 
                                   [class.pi-check-circle]="cashPayment.get('changeDue')?.value >= 0"
                                   [class.pi-exclamation-triangle]="cashPayment.get('changeDue')?.value < 0"
                                   [class.text-green-600]="cashPayment.get('changeDue')?.value >= 0"
                                   [class.text-red-600]="cashPayment.get('changeDue')?.value < 0"></i>
                                <span class="font-semibold"
                                      [class.text-green-800]="cashPayment.get('changeDue')?.value >= 0"
                                      [class.text-red-800]="cashPayment.get('changeDue')?.value < 0"
                                      [class.dark:text-green-300]="cashPayment.get('changeDue')?.value >= 0"
                                      [class.dark:text-red-300]="cashPayment.get('changeDue')?.value < 0">
                                    {{ cashPayment.get('changeDue')?.value >= 0 ? 'Payment Complete' : 'Payment Incomplete' }}
                                </span>
                            </div>
                        </div>
                    </div>
                </ng-container>
                }
            </div>
        </div>

        <div class="w-full mt-4">
            <div class="field">
                <label for="notes">Notes</label>
                <textarea id="notes" pTextarea formControlName="notes" rows="3" class="w-full"></textarea>
            </div>
        </div>

    </form>
    }
    <ng-template pTemplate="footer">
        <div class="flex justify-end gap-2">
            <p-button label="Cancel" severity="danger" icon="pi pi-times" (click)="hideDialog()">
            </p-button>
            <p-button label="Save" severity="success" icon="pi pi-check" (click)="saveOrder()">
            </p-button>
        </div>
    </ng-template>
</p-dialog>

<!-- Toast for messages -->
<p-toast></p-toast>

<!-- Confirmation dialog for delete -->
<p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>